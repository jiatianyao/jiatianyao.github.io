<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="人生在勤 勤则不匮">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="人生在勤 勤则不匮">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description" content="人生在勤 勤则不匮">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title> Hexo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7429985a9690d626019a4aae76bf7702";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Hexo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      

    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/09/python 初探/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/09/python 初探/" itemprop="url">
                  未命名
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-09T08:19:26+08:00">
                2017-01-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/09/python 初探/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/09/python 初探/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="python-初探"><a href="#python-初探" class="headerlink" title="python 初探"></a>python 初探</h1><p>标签（空格分隔）： 未分类</p>
<hr>
<p>Python是一种解释型语言，不用编译<br>Python是交互式语言<br>Python是面向对象的语言</p>
<p>从简单的文字处理到爬虫游戏</p>
<p>python有2个分支，一个是2.x 一个是3.x语法会不同<br>例如print 1 在3.x版本是一个函数要写成print(1)</p>
<p>和java不同的是有以下两个类型<br>定义元祖类型()   元组是可读的<br>定义字典类型{}</p>
<p>初始化a={2,3}  type以下a的类型为set   </p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/01/04/算法思维/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/04/算法思维/" itemprop="url">
                  算法思维
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-04T20:36:47+08:00">
                2017-01-04
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2017/01/04/算法思维/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/04/算法思维/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>火柴棍游戏</p>
<p><img src="http://oh6ybr0jg.bkt.clouddn.com/6008.png" alt="此处输入图片的描述"></p>
<p>移动两根火柴得到的最大值是多少？</p>
<p>一般人的第一反应是：<br><img src="http://oh6ybr0jg.bkt.clouddn.com/9809.png" alt="此处输入图片的描述"></p>
<p>如果我们想到了位数越多，数字越大，就会想到：<br><img src="http://oh6ybr0jg.bkt.clouddn.com/61008.png" alt="此处输入图片的描述"></p>
<p>此时如果想到了平方计算<br><img src="http://oh6ybr0jg.bkt.clouddn.com/500~9.png" alt="此处输入图片的描述"></p>
<p>那么你需要的是继续发散四位，想到科学计数法<br><img src="http://oh6ybr0jg.bkt.clouddn.com/6e80.png" alt="此处输入图片的描述"></p>
<p>但是此时并不是最大的</p>
<p>只有当你想到了以下的数据，那么恭喜你成功了<br><img src="http://oh6ybr0jg.bkt.clouddn.com/6ee8.png" alt="此处输入图片的描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/28/spring boot solr/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/28/spring boot solr/" itemprop="url">
                  spring boot solr
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-28T23:33:30+08:00">
                2016-12-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/28/spring boot solr/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/28/spring boot solr/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>pom引入solr的jar包<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-data-solr&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/19/docker玩kafka集群/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/19/docker玩kafka集群/" itemprop="url">
                  docker版Kafka集群
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-19T12:33:30+08:00">
                2016-12-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/19/docker玩kafka集群/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/19/docker玩kafka集群/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="入手centos7"><a href="#入手centos7" class="headerlink" title="入手centos7"></a>入手centos7</h3><p>首先打开centos 官网下载<br><a href="https://www.centos.org/download/" target="_blank" rel="external">https://www.centos.org/download/</a></p>
<p>选择DVD ISO</p>
<p>找到地址并下载<br><a href="http://101.96.8.151/isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1611.iso" target="_blank" rel="external">http://101.96.8.151/isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1611.iso</a></p>
<p>安装参考：<br><a href="http://blog.csdn.net/alex_my/article/details/38142229" target="_blank" rel="external">http://blog.csdn.net/alex_my/article/details/38142229</a></p>
<h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p>安装详情可参考官网<br><a href="https://docs.docker.com/engine/installation/linux/centos/" target="_blank" rel="external">https://docs.docker.com/engine/installation/linux/centos/</a></p>
<p>博主使用另外一种简单方式安装<br>安装docker<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install docker</div></pre></td></tr></table></figure></p>
<p>启动服务（CENTOS7之前的版本）<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">service docker start</div><div class="line">chkconfig docker on</div></pre></td></tr></table></figure></p>
<p>Centos之后的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl  start docker.service</div><div class="line">systemctl  enable docker.service</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">docker version</div><div class="line">Client:</div><div class="line"> Version:         <span class="number">1.10</span><span class="number">.3</span></div><div class="line"> API version:     <span class="number">1.22</span></div><div class="line"> Package version: docker-common<span class="number">-1.10</span><span class="number">.3</span><span class="number">-59.</span>el7.centos.x86_64</div><div class="line"> Go version:      go1<span class="number">.6</span><span class="number">.3</span></div><div class="line"> Git commit:      <span class="number">3999</span>ccb-unsupported</div><div class="line"> Built:           Thu Dec <span class="number">15</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">43</span> <span class="number">2016</span></div><div class="line"> OS/Arch:         linux/amd64</div><div class="line"></div><div class="line">Server:</div><div class="line"> Version:         <span class="number">1.10</span><span class="number">.3</span></div><div class="line"> API version:     <span class="number">1.22</span></div><div class="line"> Package version: docker-common<span class="number">-1.10</span><span class="number">.3</span><span class="number">-59.</span>el7.centos.x86_64</div><div class="line"> Go version:      go1<span class="number">.6</span><span class="number">.3</span></div><div class="line"> Git commit:      <span class="number">3999</span>ccb-unsupported</div><div class="line"> Built:           Thu Dec <span class="number">15</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">43</span> <span class="number">2016</span></div><div class="line"> OS/Arch:         linux/amd64</div></pre></td></tr></table></figure>
<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><p>博主当时有1.7.1的版本在安装完之后启动报错<br>Cannot open self /usr/bin/docker-compose or archive /usr/bin/docker-compose.pkg</p>
<p>后改用早一点的版本1.7.0测试没有问题<br>下载和安装地址可参考：<br><a href="https://github.com/docker/compose/releases?after=docs-v1.7.1-2016-05-31" target="_blank" rel="external">https://github.com/docker/compose/releases?after=docs-v1.7.1-2016-05-31</a><br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -L https:<span class="comment">//github.com/docker/compose/releases/download/1.7.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span></div><div class="line">chmod +x /usr/local/bin/docker-compose</div><div class="line"></div><div class="line">docker-compose version</div><div class="line">docker-compose version <span class="number">1.7</span><span class="number">.0</span>, build <span class="number">0</span>d7bf73</div><div class="line">docker-py version: <span class="number">1.8</span><span class="number">.0</span></div><div class="line">CPython version: <span class="number">2.7</span><span class="number">.9</span></div><div class="line">OpenSSL version: OpenSSL <span class="number">1.0</span><span class="number">.1</span>e <span class="number">11</span> Feb <span class="number">2013</span></div></pre></td></tr></table></figure></p>
<p>编写docker文件，此处参考Jason大神的，尊重原创，转载请标注<br>kafka.Dockerfile<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">FROM centos:<span class="number">6.6</span></div><div class="line"></div><div class="line">RUN mkdir /etc/yum.repos.d/backup &amp;&amp;\</div><div class="line">	mv /etc/yum.repos.d<span class="comment">/*.repo /etc/yum.repos.d/backup/ &amp;&amp;\</span></div><div class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</div><div class="line"></div><div class="line">RUN yum -y install vim lsof wget tar bzip2 unzip vim-enhanced passwd sudo yum-utils hostname net-tools rsync man git make automake cmake patch logrotate python-devel libpng-devel libjpeg-devel pwgen python-pip</div><div class="line"></div><div class="line">RUN mkdir /opt/java &amp;&amp;\</div><div class="line">	wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u102-b14/jdk-8u102-linux-x64.tar.gz -P /opt/java</div><div class="line"></div><div class="line">ENV KAFKA_VERSION "0.8.2.2"</div><div class="line"></div><div class="line">RUN mkdir /opt/kafka &amp;&amp;\</div><div class="line">	wget http://apache.fayea.com/kafka/$KAFKA_VERSION/kafka_2.11-$KAFKA_VERSION.tgz -P /opt/kafka</div><div class="line"></div><div class="line">RUN tar zxvf /opt/java/jdk-8u102-linux-x64.tar.gz -C /opt/java &amp;&amp;\</div><div class="line">	JAVA_HOME=/opt/java/jdk1.8.0_102 &amp;&amp;\</div><div class="line">	sed -i "/^PATH/i export JAVA_HOME=$JAVA_HOME" /root/.bash_profile &amp;&amp;\</div><div class="line">	sed -i "s%^PATH.*$%&amp;:$JAVA_HOME/bin%g" /root/.bash_profile &amp;&amp;\</div><div class="line">	source /root/.bash_profile</div><div class="line"></div><div class="line">RUN tar zxvf /opt/kafka/kafka*.tgz -C /opt/kafka &amp;&amp;\</div><div class="line">	sed -i 's/num.partitions.*$/num.partitions=3/g' /opt/kafka/kafka_2.11-$KAFKA_VERSION/config/server.properties</div><div class="line"></div><div class="line">RUN echo "source /root/.bash_profile" &gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "cd /opt/kafka/kafka_2.11-"$KAFKA_VERSION &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	#echo "sed -i 's%zookeeper.connect=.*$%zookeeper.connect=zookeeper:2181%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "[ ! -z $""ZOOKEEPER_CONNECT"" ] &amp;&amp; sed -i 's%.*zookeeper.connect=.*$%zookeeper.connect='$""ZOOKEEPER_CONNECT'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "[ ! -z $""BROKER_ID"" ] &amp;&amp; sed -i 's%broker.id=.*$%broker.id='$""BROKER_ID'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "[ ! -z $""BROKER_PORT"" ] &amp;&amp; sed -i 's%port=.*$%port='$""BROKER_PORT'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "sed -i 's%#advertised.host.name=.*$%advertised.host.name='$""(hostname -i)'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "[ ! -z $""ADVERTISED_HOST_NAME"" ] &amp;&amp; sed -i 's%.*advertised.host.name=.*$%advertised.host.name='$""ADVERTISED_HOST_NAME'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "sed -i 's%#host.name=.*$%host.name='$""(hostname -i)'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "[ ! -z $""HOST_NAME"" ] &amp;&amp; sed -i 's%.*host.name=.*$%host.name='$""HOST_NAME'""%g'  /opt/kafka/kafka_2.11-"$KAFKA_VERSION"/config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	echo "delete.topic.enable=true" &gt;&gt; /opt/kafka/kafka_2.11-$KAFKA_VERSION/config/server.properties &amp;&amp;\</div><div class="line">	echo "bin/kafka-server-start.sh config/server.properties" &gt;&gt; /opt/kafka/start.sh &amp;&amp;\</div><div class="line">	chmod a+x /opt/kafka/start.sh</div><div class="line"></div><div class="line">RUN yum install -y nc</div><div class="line"></div><div class="line">EXPOSE 9092</div><div class="line"></div><div class="line">WORKDIR /opt/kafka/kafka_2.11-$KAFKA_VERSION</div><div class="line"></div><div class="line">ENTRYPOINT ["sh", "/opt/kafka/start.sh"]</div></pre></td></tr></table></figure></p>
<p>zookeeper.Dockerfile<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">FROM centos:6.6</div><div class="line"></div><div class="line">RUN mkdir /etc/yum.repos.d/backup &amp;&amp;\</div><div class="line">	mv /etc/yum.repos.d/*.repo /etc/yum.repos.d/backup/ &amp;&amp;\</div><div class="line">	curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</div><div class="line"></div><div class="line">RUN yum -y install vim lsof wget tar bzip2 unzip vim-enhanced passwd sudo yum-utils hostname net-tools rsync man git make automake cmake patch logrotate python-devel libpng-devel libjpeg-devel pwgen python-pip</div><div class="line"></div><div class="line">RUN mkdir /opt/java &amp;&amp;\</div><div class="line">	wget --no-check-certificate --no-cookies --header &quot;Cookie: oraclelicense=accept-securebackup-cookie&quot; http://download.oracle.com/otn-pub/java/jdk/8u102-b14/jdk-8u102-linux-x64.tar.gz -P /opt/java</div><div class="line"></div><div class="line">RUN tar zxvf /opt/java/jdk-8u102-linux-x64.tar.gz -C /opt/java &amp;&amp;\</div><div class="line">	JAVA_HOME=/opt/java/jdk1.8.0_102 &amp;&amp;\</div><div class="line">	sed -i &quot;/^PATH/i export JAVA_HOME=$JAVA_HOME&quot; /root/.bash_profile &amp;&amp;\</div><div class="line">	sed -i &quot;s%^PATH.*$%&amp;:$JAVA_HOME/bin%g&quot; /root/.bash_profile &amp;&amp;\</div><div class="line">	source /root/.bash_profile</div><div class="line"></div><div class="line">ENV ZOOKEEPER_VERSION &quot;3.4.6&quot;</div><div class="line"></div><div class="line">RUN mkdir /opt/zookeeper &amp;&amp;\</div><div class="line">	wget http://mirror.olnevhost.net/pub/apache/zookeeper/zookeeper-$ZOOKEEPER_VERSION/zookeeper-$ZOOKEEPER_VERSION.tar.gz -P /opt/zookeeper</div><div class="line"></div><div class="line">RUN tar zxvf /opt/zookeeper/zookeeper*.tar.gz -C /opt/zookeeper</div><div class="line"></div><div class="line">RUN echo &quot;source /root/.bash_profile&quot; &gt; /opt/zookeeper/start.sh &amp;&amp;\</div><div class="line">	echo &quot;cp /opt/zookeeper/zookeeper-&quot;$ZOOKEEPER_VERSION&quot;/conf/zoo_sample.cfg /opt/zookeeper/zookeeper-&quot;$ZOOKEEPER_VERSION&quot;/conf/zoo.cfg&quot; &gt;&gt; /opt/zookeeper/start.sh &amp;&amp;\</div><div class="line">	echo &quot;[ ! -z $&quot;&quot;ZOOKEEPER_PORT&quot;&quot; ] &amp;&amp; sed -i &apos;s%.*clientPort=.*$%clientPort=&apos;$&quot;&quot;ZOOKEEPER_PORT&apos;&quot;&quot;%g&apos;  /opt/zookeeper/zookeeper-&quot;$ZOOKEEPER_VERSION&quot;/conf/zoo.cfg&quot; &gt;&gt; /opt/zookeeper/start.sh &amp;&amp;\</div><div class="line">	echo &quot;[ ! -z $&quot;&quot;ZOOKEEPER_ID&quot;&quot; ] &amp;&amp; mkdir -p /tmp/zookeeper &amp;&amp; echo $&quot;&quot;ZOOKEEPER_ID &gt; /tmp/zookeeper/myid&quot; &gt;&gt; /opt/zookeeper/start.sh &amp;&amp;\</div><div class="line">	echo &quot;[[ ! -z $&quot;&quot;ZOOKEEPER_SERVERS&quot;&quot; ]] &amp;&amp; for server in $&quot;&quot;ZOOKEEPER_SERVERS&quot;&quot;; do echo $&quot;&quot;server&quot;&quot; &gt;&gt; /opt/zookeeper/zookeeper-&quot;$ZOOKEEPER_VERSION&quot;/conf/zoo.cfg; done&quot; &gt;&gt; /opt/zookeeper/start.sh &amp;&amp;\</div><div class="line">	echo &quot;/opt/zookeeper/zookeeper-$&quot;ZOOKEEPER_VERSION&quot;/bin/zkServer.sh start-foreground&quot; &gt;&gt; /opt/zookeeper/start.sh</div><div class="line"></div><div class="line">RUN yum install -y nc</div><div class="line"></div><div class="line">EXPOSE 2181</div><div class="line"></div><div class="line">WORKDIR /opt/zookeeper/zookeeper-$ZOOKEEPER_VERSION</div><div class="line"></div><div class="line">ENTRYPOINT [&quot;sh&quot;, &quot;/opt/zookeeper/start.sh&quot;]</div></pre></td></tr></table></figure></p>
<p>docker-compose.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line">version: &apos;2.0&apos;</div><div class="line">services:</div><div class="line">  zookeeper0:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: zookeeper.Dockerfile</div><div class="line">    image: jason/zookeeper:3.4.6</div><div class="line">    container_name: zookeeper0</div><div class="line">    hostname: zookeeper0</div><div class="line">    ports:</div><div class="line">      - &quot;2181:2181&quot;</div><div class="line">      - &quot;2888:2888&quot;</div><div class="line">      - &quot;3888:3888&quot;</div><div class="line">    expose:</div><div class="line">      - 2181</div><div class="line">      - 2888</div><div class="line">      - 3888</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_PORT: 2181</div><div class="line">      ZOOKEEPER_ID: 0</div><div class="line">      ZOOKEEPER_SERVERS: server.0=zookeeper0:2888:3888 server.1=zookeeper1:28881:38881 server.2=zookeeper2:28882:38882</div><div class="line">  zookeeper1:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: zookeeper.Dockerfile</div><div class="line">    image: jason/zookeeper:3.4.6</div><div class="line">    container_name: zookeeper1</div><div class="line">    hostname: zookeeper1</div><div class="line">    ports:</div><div class="line">      - &quot;2182:2182&quot;</div><div class="line">      - &quot;28881:28881&quot;</div><div class="line">      - &quot;38881:38881&quot;</div><div class="line">    expose:</div><div class="line">      - 2182</div><div class="line">      - 2888</div><div class="line">      - 3888</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_PORT: 2182</div><div class="line">      ZOOKEEPER_ID: 1</div><div class="line">      ZOOKEEPER_SERVERS: server.0=zookeeper0:2888:3888 server.1=zookeeper1:28881:38881 server.2=zookeeper2:28882:38882</div><div class="line">#    depends_on:</div><div class="line">#      - zookeeper0</div><div class="line">  zookeeper2:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: zookeeper.Dockerfile</div><div class="line">    image: jason/zookeeper:3.4.6</div><div class="line">    container_name: zookeeper2</div><div class="line">    hostname: zookeeper2</div><div class="line">    ports:</div><div class="line">      - &quot;2183:2183&quot;</div><div class="line">      - &quot;28882:28882&quot;</div><div class="line">      - &quot;38882:38882&quot;</div><div class="line">    expose:</div><div class="line">      - 2183</div><div class="line">      - 2888</div><div class="line">      - 3888</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_PORT: 2183</div><div class="line">      ZOOKEEPER_ID: 2</div><div class="line">      ZOOKEEPER_SERVERS: server.0=zookeeper0:2888:3888 server.1=zookeeper1:28881:38881 server.2=zookeeper2:28882:38882</div><div class="line">#    depends_on:</div><div class="line">#        - zookeeper1</div><div class="line">  kafka0:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: kafka.Dockerfile</div><div class="line">    image: jason/kafka:0.8.2.2</div><div class="line">    container_name: kafka0</div><div class="line">    hostname: kafka0</div><div class="line">    ports:</div><div class="line">      - &quot;9092:9092&quot;</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_CONNECT: zookeeper0:2181,zookeeper1:2182,zookeeper2:2183/kafka</div><div class="line">      BROKER_ID: 0</div><div class="line">      BROKER_PORT: 9092</div><div class="line">      ADVERTISED_HOST_NAME: kafka0</div><div class="line">      HOST_NAME: kafka0</div><div class="line">    volumes:</div><div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div><div class="line">    depends_on:</div><div class="line">        - zookeeper0</div><div class="line">        - zookeeper1</div><div class="line">        - zookeeper2</div><div class="line">    expose:</div><div class="line">      - 9092</div><div class="line">#    links:</div><div class="line">#      - zookeeper</div><div class="line">  kafka1:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: kafka.Dockerfile</div><div class="line">    image: jason/kafka:0.8.2.2</div><div class="line">    container_name: kafka1</div><div class="line">    hostname: kafka1</div><div class="line">    ports:</div><div class="line">      - &quot;9093:9093&quot;</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_CONNECT: zookeeper0:2181,zookeeper1:2182,zookeeper2:2183/kafka</div><div class="line">      BROKER_ID: 1</div><div class="line">      BROKER_PORT: 9093</div><div class="line">      ADVERTISED_HOST_NAME: kafka1</div><div class="line">      HOST_NAME: kafka1</div><div class="line">    volumes:</div><div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div><div class="line">    depends_on:</div><div class="line">        - zookeeper0</div><div class="line">        - zookeeper1</div><div class="line">        - zookeeper2</div><div class="line">    expose:</div><div class="line">      - 9093</div><div class="line">#    links:</div><div class="line">#      - zookeeper</div><div class="line">  kafka2:</div><div class="line">    build: .</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: kafka.Dockerfile</div><div class="line">    image: jason/kafka:0.8.2.2</div><div class="line">    container_name: kafka2</div><div class="line">    hostname: kafka2</div><div class="line">    ports:</div><div class="line">      - &quot;9094:9094&quot;</div><div class="line">    environment:</div><div class="line">      ZOOKEEPER_CONNECT: zookeeper0:2181,zookeeper1:2182,zookeeper2:2183/kafka</div><div class="line">      BROKER_ID: 2</div><div class="line">      BROKER_PORT: 9094</div><div class="line">      ADVERTISED_HOST_NAME: kafka2</div><div class="line">      HOST_NAME: kafka2</div><div class="line">    volumes:</div><div class="line">      - /var/run/docker.sock:/var/run/docker.sock</div><div class="line">    depends_on:</div><div class="line">        - zookeeper0</div><div class="line">        - zookeeper1</div><div class="line">        - zookeeper2</div><div class="line">    expose:</div><div class="line">      - 9094</div><div class="line">#   links:</div><div class="line">#     - zookeeper</div></pre></td></tr></table></figure></p>
<p>启动docker-compose<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@zhm1 docker-file]# docker-compose up -d</div></pre></td></tr></table></figure></p>
<p>如果曾经有启动的需要先停止移除在启动<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@zhm1 docker-file]# docker-compose stop;docker-compose rm -f</div></pre></td></tr></table></figure></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@zhm1 docker-file]# docker ps</div><div class="line">CONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                                                                                                      NAMES</div><div class="line">891585b4767a        jason/kafka:0.8.2.2     "sh /opt/kafka/start."   About an hour ago   Up About an hour    9092/tcp, 0.0.0.0:9093-&gt;9093/tcp                                                                           kafka1</div><div class="line">81f90ccb917a        jason/kafka:0.8.2.2     "sh /opt/kafka/start."   About an hour ago   Up About an hour    9092/tcp, 0.0.0.0:9094-&gt;9094/tcp                                                                           kafka2</div><div class="line">2edb39ed0e97        jason/kafka:0.8.2.2     "sh /opt/kafka/start."   About an hour ago   Up About an hour    0.0.0.0:9092-&gt;9092/tcp                                                                                     kafka0</div><div class="line">b21ac8fb0f72        jason/zookeeper:3.4.6   "sh /opt/zookeeper/st"   About an hour ago   Up About an hour    2181/tcp, 2888/tcp, 0.0.0.0:2183-&gt;2183/tcp, 0.0.0.0:28882-&gt;28882/tcp, 3888/tcp, 0.0.0.0:38882-&gt;38882/tcp   zookeeper2</div><div class="line">48f5ada24ff7        jason/zookeeper:3.4.6   "sh /opt/zookeeper/st"   About an hour ago   Up About an hour    0.0.0.0:2181-&gt;2181/tcp, 0.0.0.0:2888-&gt;2888/tcp, 0.0.0.0:3888-&gt;3888/tcp                                     zookeeper0</div><div class="line">d247a8ac6a30        jason/zookeeper:3.4.6   "sh /opt/zookeeper/st"   About an hour ago   Up About an hour    2181/tcp, 2888/tcp, 0.0.0.0:2182-&gt;2182/tcp, 0.0.0.0:28881-&gt;28881/tcp, 3888/tcp, 0.0.0.0:38881-&gt;38881/tcp   zookeeper1</div></pre></td></tr></table></figure>
<p>此时可以进入容器内查看：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker exec -it zookeeper0 bash</div><div class="line">source /root/.bash_profile</div><div class="line">bin/zkCli.sh -server zookeeper0:<span class="number">2181</span></div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[zk: zookeeper0:<span class="number">2182</span>(CONNECTED) <span class="number">0</span>] ls /</div><div class="line">[zookeeper, kafka]</div><div class="line">[zk: zookeeper0:<span class="number">2182</span>(CONNECTED) <span class="number">1</span>] ls /kafka</div><div class="line">[admin, consumers, controller, controller_epoch, brokers, config]</div><div class="line">[zk: zookeeper0:<span class="number">2182</span>(CONNECTED) <span class="number">2</span>] ls /kafka/brokers/ids</div><div class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</div><div class="line">[zk: zookeeper0:<span class="number">2182</span>(CONNECTED) <span class="number">3</span>]</div></pre></td></tr></table></figure>
<p>此处注意，因为docker-compose.yml文件里配置的kafka引用zookeeper根目录下的kafka目录，故在写zookeeper的时候要增加/kafka<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@zhm1 docker-file]# docker exec -it kafka0 bash</div><div class="line">[root@kafka0 kafka_2.11-0.8.2.2]# source /root/.bash_profile</div><div class="line">[root@kafka0 kafka_2.11-0.8.2.2]# bin/kafka-topics.sh --zookeeper zookeeper0:2181/kafka --topic topic1 --create --partitions 3 --replication-factor 1</div><div class="line">Created topic "topic1".</div><div class="line">[root@kafka0 kafka_2.11-0.8.2.2]# bin/kafka-topics.sh --zookeeper zookeeper0:2181/kafka --topic topic1 --describe                                    </div><div class="line">Topic:topic1    PartitionCount:3        ReplicationFactor:1     Configs:</div><div class="line">        Topic: topic1   Partition: 0    Leader: 1       Replicas: 1     Isr: 1</div><div class="line">        Topic: topic1   Partition: 1    Leader: 2       Replicas: 2     Isr: 2</div><div class="line">        Topic: topic1   Partition: 2    Leader: 0       Replicas: 0     Isr: 0</div></pre></td></tr></table></figure></p>
<h3 id="kafka术语"><a href="#kafka术语" class="headerlink" title="kafka术语"></a>kafka术语</h3><h4 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h4><p>Topic,是KAFKA对消息分类的依据;一条消息,必须有一个与之对应的Topic;<br>比如现在又两个Topic,分别是TopicA和TopicB,Producer向TopicA发送一个消息messageA,然后向TopicB发送一个消息messaeB;那么,订阅TopicA的Consumer就会收到消息messageA,订阅TopicB的Consumer就会收到消息messaeB;(每个Consumer可以同时订阅多个Topic,也即是说,同时订阅TopicA和TopicB的Consumer可以收到messageA和messaeB)。<br>同一个Group id的consumers在同一个Topic的同一条消息只能被一个consumer消费，实现了点对点模式，不同Group id的Consumers在同一个Topic上的同一条消息可以同时消费到，则实现了发布订阅模式。通过Consumer的Group id实现了JMS的消息模式</p>
<h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4><p>每一个Topic可以有多个Partition,这样做是为了提高KAFKA系统的并发能力，每个Partition中按照消息发送的顺序保存着Producer发来的消息,每个消息用ID标识,代表这个消息在改Partition中的偏移量,这样,知道了ID,就可以方便的定位一个消息了;每个新提交过来的消息,被追加到Partition的尾部;如果一个Partition被写满了,就不再追加;(注意,KAFKA不保证不同Partition之间的消息有序保存)</p>
<h4 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h4><p>Partition中负责消息读写的节点;Leader是从Partition的节点中随机选取的。每个Partition都会在集中的其中一台服务器存在Leader。一个Topic如果有多个Partition，则会有多个Leader。</p>
<h4 id="ReplicationFactor"><a href="#ReplicationFactor" class="headerlink" title="ReplicationFactor"></a>ReplicationFactor</h4><p>一个Partition中复制数据的所有节点,包括已经挂了的;数量不会超过集群中broker的数量</p>
<h4 id="isr"><a href="#isr" class="headerlink" title="isr"></a>isr</h4><p>ReplicationFactor的子集,存活的且和Leader保持同步的节点;leade会维护一个与其基本保持同步的Replica列表，该列表成为ISR（in-sync Replica）.如果一个Follower比leader落后太多，或者超过一段时间未发起数据复制请求（kafka的数据复制是follower的pull形式），则leader将其从ISR中移除</p>
<p>balabala..那么多，来个实例玩玩吧</p>
<p>打开另外一个终端，进入kafka1启动个消费者，此处要注意消费者路径也要指定kafka<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@kafka1 kafka_2.11-0.8.2.2]# bin/kafka-console-consumer.sh --zookeeper zookeeper0:2181,zookeeper1:2182,zookeeper2:2183/kafka --topic topic3 --from-beginning</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@kafka0 kafka_2.11-0.8.2.2]# bin/kafka-console-producer.sh --broker-list kafka0:9092 --topic topic3</div></pre></td></tr></table></figure>
<p>输入hello world</p>
<p>另外一个终端显示<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@kafka1 kafka_2.11-0.8.2.2]# bin/kafka-console-consumer.sh --zookeeper zookeeper0:2181,zookeeper1:2182,zookeeper2:2183/kafka --topic topic3 --from-beginning</div><div class="line">hello world</div></pre></td></tr></table></figure></p>
<p>如果设置topic的时候设置log.cleanup.policy为compact，则消费的消息会被压缩</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/13/码云操作/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/13/码云操作/" itemprop="url">
                  用git上传代码到码云
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-13T10:33:30+08:00">
                2016-12-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/13/码云操作/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/13/码云操作/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>用git上传代码到码云</p>
<p>下载git客户端<br>Window 下的安装<br>从 <a href="http://git-scm.com/download" target="_blank" rel="external">http://git-scm.com/download</a> 上下载window版的客户端，然后一直下一步下一步安装git即可，请注意，如果你不熟悉每个选项的意思，请保持默认的选项</p>
<p>git config –global user.name Jenick<br>git config –global user.email 258409707@qq.com</p>
<p>以下内容Wie转载：<br>1.先在远程库创建项目，然后复制远程库里面的项目的地址；</p>
<p>2.打开命令行（电脑上用windows+R键），创建一个文件夹用于从远程库里克</p>
<p>隆所要更改的文件：命令为：mkdir + “目录名”；</p>
<p>3.用cd + “目录名”跳转到所创建的目录名下，用命令git clone +远程库</p>
<p>文件地址；此时刷新所创建的目录，会发现新出现了一个文件夹，那就是</p>
<p>从远程库里面复制的文件目录（里面包含有后缀为.git的文件）</p>
<p>4.用cd 命令跳转到新的文件夹里，把所需要提交的文件复制到这个文件夹</p>
<p>里；</p>
<p>5.用git status命令能看到所改变了的文件目录列表，用git diff命令能看</p>
<p>到具体改变了的哪一行代码；</p>
<p>6.用命令git branch + “分支名”创建本地分支，用命令git branch可查看</p>
<p>目前所在分支，用 git checkout “你所创建的分支名”；跳转到你所创建的分</p>
<p>支；</p>
<p>7.用git  add+(空格)+ “.”将所有的修改追加到文件中去；</p>
<p>8.用git commit -m“更改的文件备注”命令将你的文件提交到本地库；</p>
<p>9.用git checkout master 切换回到主分支；</p>
<p>10.用git pull  origin  master 命令将主分支从远程仓库里面拉过来；</p>
<p>11.用git merge+”你所创建的分支名”合并分支；</p>
<p>12.用git push  origin  master 命令将合并分支提交到远程库；</p>
<p>13.刷新一下远程库，就能发现所要提交的文件了</p>
<p>文／玄薛烨（简书作者）<br>原文链接：<a href="http://www.jianshu.com/p/edf037f921c7" target="_blank" rel="external">http://www.jianshu.com/p/edf037f921c7</a><br>著作权归作者所有，转载请联系作者获得授权，并标注“简书作者”。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/07/kafka stream 实战3/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/07/kafka stream 实战3/" itemprop="url">
                  kafka stream 实战3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-07T16:57:52+08:00">
                2016-12-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/07/kafka stream 实战3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/07/kafka stream 实战3/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>场景： 每5秒输出过去1小时18岁到35岁用户所购买的商品中，每种品类销售额排名前十的订单汇总信息。<br>    使用数据内的时间(Event Time)作为timestamp<br>    每5秒输出一次<br>    每次计算到输出为止过去1小时的数据<br>    支持订单详情和用户详情的更新和增加<br>    输出字段包含时间窗口（起始时间，结束时间），品类（category），商品名（item_name），销量（quantity），单价（price），总销售额，该商品在该品类内的销售额排名</p>
<p>随机创建数据的类<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"><span class="keyword">import</span> java.text.ParseException;</div><div class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</div><div class="line"><span class="keyword">import</span> java.util.Calendar;</div><div class="line"><span class="keyword">import</span> java.util.Date;</div><div class="line"><span class="keyword">import</span> java.util.Random;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by Administrator on 2016/12/30.</div><div class="line"> */</div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">createFile</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//c创建订单文件</span></div><div class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException, ParseException &#123;</div><div class="line">        FileOutputStream outSTr = <span class="literal">null</span>;</div><div class="line">        FileOutputStream out = <span class="literal">null</span>;</div><div class="line">        BufferedOutputStream Buff=<span class="literal">null</span>;</div><div class="line"></div><div class="line">        outSTr = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(<span class="string">"C:/add2.csv"</span>));</div><div class="line">        Buff=<span class="keyword">new</span> BufferedOutputStream(outSTr);</div><div class="line"></div><div class="line">        <span class="built_in">String</span>[] a1 = &#123;<span class="string">"Jack"</span>, <span class="string">"Lily"</span>, <span class="string">"Mike"</span>, <span class="string">"Lucy"</span>, <span class="string">"LiLei"</span>, <span class="string">"HanMeimei"</span>&#125;;</div><div class="line">        Random rand = <span class="keyword">new</span> Random();</div><div class="line"></div><div class="line">        <span class="built_in">String</span>[] a2 = &#123;<span class="string">"iphone"</span>, <span class="string">"ipad"</span>, <span class="string">"iwatch"</span>, <span class="string">"ipod"</span>&#125;;</div><div class="line"></div><div class="line">        Calendar calendar = Calendar.getInstance();</div><div class="line">        <span class="built_in">String</span> str=<span class="string">"2016-11-11 00:00:00"</span>;</div><div class="line"></div><div class="line">        SimpleDateFormat sdf= <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line"></div><div class="line">        <span class="built_in">Date</span> date =sdf.parse(str);</div><div class="line">        calendar.setTime(date);</div><div class="line"></div><div class="line">        System.out.println (calendar.getTime ());</div><div class="line"></div><div class="line">        SimpleDateFormat sdf2 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line"></div><div class="line">        <span class="built_in">String</span> dateStr = <span class="string">""</span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        int count = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span>(! (count == <span class="number">60</span>*<span class="number">60</span>*<span class="number">24</span>))&#123;<span class="comment">//86400</span></div><div class="line">            System.out.println(count);</div><div class="line">            count++;</div><div class="line">            System.out.println(dateStr);</div><div class="line">            int num = rand.nextInt(a1.length);</div><div class="line">           <span class="comment">// System.out.println(a1[num]);</span></div><div class="line"></div><div class="line">            int num2 = rand.nextInt(a2.length);</div><div class="line">           <span class="comment">// System.out.println(a2[num2]);</span></div><div class="line"></div><div class="line">            calendar.add (Calendar.SECOND, <span class="number">1</span>);</div><div class="line">            sdf2.format(calendar.getTime());</div><div class="line">            dateStr = sdf2.format(calendar.getTime());</div><div class="line">           <span class="comment">// System.out.println (dateStr);</span></div><div class="line">            Buff.write((a1[num]+<span class="string">","</span>+a2[num2]+<span class="string">", "</span>+dateStr+<span class="string">","</span>+rand.nextInt(<span class="number">5</span>)+<span class="string">"\r\n"</span>).getBytes());</div><div class="line">            Buff.flush();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他文件在实践1里有</p>
<p>编写DSL文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"><span class="keyword">import</span> java.util.Collections;</div><div class="line"><span class="keyword">import</span> java.util.Comparator;</div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serdes;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KafkaStreams;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KeyValue;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.StreamsConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStream;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStreamBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KTable;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.TimeWindows;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.Windowed;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.Item;</div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.Order;</div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.User;</div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.serdes.SerdesFactory;</div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.timeextractor.OrderTimestampExtractor;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by root on 17-1-5.</div><div class="line"> */</div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">topN</span> </span>&#123;</div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException, InterruptedException &#123;</div><div class="line">        Properties props = <span class="keyword">new</span> Properties();</div><div class="line">        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">"streams-purchase-analysis2"</span>);</div><div class="line">        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"jenick.com:9092"</span>);</div><div class="line">        props.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, <span class="string">"jenick.com:2181"</span>);</div><div class="line">        props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line">        props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"earliest"</span>);</div><div class="line">        props.put(StreamsConfig.TIMESTAMP_EXTRACTOR_CLASS_CONFIG, OrderTimestampExtractor.class);</div><div class="line"></div><div class="line">        KStreamBuilder streamBuilder = <span class="keyword">new</span> KStreamBuilder();</div><div class="line">        KStream&lt;<span class="built_in">String</span>, Order&gt; orderStream = streamBuilder.stream(Serdes.String(), SerdesFactory.serdFrom(Order.class), <span class="string">"orders"</span>);</div><div class="line">        KTable&lt;<span class="built_in">String</span>, User&gt; userTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(User.class), <span class="string">"users"</span>, <span class="string">"users-state-store"</span>);</div><div class="line">        KTable&lt;<span class="built_in">String</span>, Item&gt; itemTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(Item.class), <span class="string">"items"</span>, <span class="string">"items-state-store"</span>);</div><div class="line">        KStream&lt;Windowed&lt;<span class="built_in">String</span>&gt;, GroupInfo&gt; kStream = orderStream</div><div class="line">                .leftJoin(userTable, (Order order, User user) -&gt; OrderUser.fromOrderUser(order, user), Serdes.String(), SerdesFactory.serdFrom(Order.class))</div><div class="line">                .filter((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; (orderUser.userAddress != <span class="literal">null</span> &amp;&amp; (orderUser.getAge() &gt;= <span class="number">18</span> &amp;&amp;  orderUser.getAge() &lt;= <span class="number">35</span> )))</div><div class="line">                .map((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, OrderUser&gt;(orderUser.itemName, orderUser))</div><div class="line">                .through(Serdes.String(), SerdesFactory.serdFrom(OrderUser.class), (<span class="built_in">String</span> key, OrderUser orderUser, int numPartitions) -&gt; (orderUser.getItemName().hashCode() &amp; <span class="number">0x7FFFFFFF</span>) % numPartitions, <span class="string">"orderuser-repartition-by-item"</span>)</div><div class="line">                .leftJoin(itemTable, (OrderUser orderUser, Item item) -&gt; OrderUserItem.fromOrderUser(orderUser, item), Serdes.String(), SerdesFactory.serdFrom(OrderUser.class))</div><div class="line">                .map((<span class="built_in">String</span> item, OrderUserItem orderUserItem) -&gt; KeyValue.&lt;<span class="built_in">String</span>, GroupInfo&gt;pair((orderUserItem.itemType),</div><div class="line">                        <span class="keyword">new</span> GroupInfo(orderUserItem.itemType, <span class="keyword">new</span> ArrayList&lt;GroupItemInfo&gt;()&#123;</div><div class="line">                            private <span class="keyword">static</span> final long serialVersionUID = <span class="number">1</span>L;</div><div class="line">                            &#123;</div><div class="line">                                add(<span class="keyword">new</span> GroupItemInfo(orderUserItem.transactionDate, orderUserItem.itemName, orderUserItem.quantity, orderUserItem.itemPrice,  (orderUserItem.quantity * orderUserItem.itemPrice)));</div><div class="line">                            &#125;&#125;)</div><div class="line">                ))</div><div class="line">                .groupByKey(Serdes.String(), SerdesFactory.serdFrom(GroupInfo.class))</div><div class="line">                .reduce((GroupInfo v1, GroupInfo v2) -&gt; &#123;</div><div class="line">                            GroupInfo v3 = <span class="keyword">new</span> GroupInfo(v1.getItemType());</div><div class="line">                            List&lt;GroupItemInfo&gt; newItemlist = <span class="keyword">new</span> ArrayList&lt;GroupItemInfo&gt;();</div><div class="line">                            newItemlist.addAll(v1.getItemList());</div><div class="line">                            newItemlist.addAll(v2.getItemList());</div><div class="line">                            v3.setItemList(newItemlist);</div><div class="line">                            <span class="keyword">return</span> v3;</div><div class="line">                        &#125;</div><div class="line">                        , TimeWindows.of(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>).advanceBy(<span class="number">1000</span> * <span class="number">5</span>)</div><div class="line">                        , <span class="string">"gender-amount-state-store"</span>).toStream();</div><div class="line">        kStream.map((Windowed&lt;<span class="built_in">String</span>&gt; <span class="built_in">window</span>, GroupInfo groupInfo) -&gt; &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;(<span class="built_in">window</span>.key(),  groupInfo.printTop10(<span class="built_in">window</span>.window().start(), <span class="built_in">window</span>.window().end()));</div><div class="line">        &#125;).to(Serdes.String(), Serdes.String(), <span class="string">"gender-amount"</span>);</div><div class="line">        KafkaStreams kafkaStreams = <span class="keyword">new</span> KafkaStreams(streamBuilder, props);</div><div class="line">        kafkaStreams.cleanUp();</div><div class="line">        kafkaStreams.start();</div><div class="line"></div><div class="line">        System.in.read();</div><div class="line">        kafkaStreams.close();</div><div class="line">        kafkaStreams.cleanUp();</div><div class="line">    &#125;</div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupInfo</span></span>&#123;</div><div class="line">        private <span class="built_in">String</span> itemType;</div><div class="line">        private List&lt;GroupItemInfo&gt; itemList;</div><div class="line"></div><div class="line">        public GroupInfo()&#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        public GroupInfo(<span class="built_in">String</span> itemType)&#123;</div><div class="line">            <span class="keyword">this</span>.itemType = itemType;</div><div class="line">        &#125;</div><div class="line">        public GroupInfo(<span class="built_in">String</span> itemType, List&lt;GroupItemInfo&gt; itemList)&#123;</div><div class="line">            <span class="keyword">this</span>.itemType = itemType;</div><div class="line">            <span class="keyword">this</span>.itemList = itemList;</div><div class="line">        &#125;</div><div class="line">        public <span class="built_in">String</span> getItemType() &#123;</div><div class="line">            <span class="keyword">return</span> itemType;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setItemType(<span class="built_in">String</span> itemType) &#123;</div><div class="line">            <span class="keyword">this</span>.itemType = itemType;</div><div class="line">        &#125;</div><div class="line">        public List&lt;GroupItemInfo&gt; getItemList() &#123;</div><div class="line">            <span class="keyword">return</span> itemList;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setItemList(List&lt;GroupItemInfo&gt; itemList) &#123;</div><div class="line">            <span class="keyword">this</span>.itemList = itemList;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 根据金额汇总倒序</div><div class="line">         * @param allItems</div><div class="line">         * @return</div><div class="line">         */</div><div class="line">        private List&lt;GroupItemInfo&gt; sortBySumDesc(Collection&lt;GroupItemInfo&gt; allItems)&#123;</div><div class="line">            List&lt;GroupItemInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;GroupItemInfo&gt;();</div><div class="line">            result.addAll(allItems);</div><div class="line">            Collections.sort(result, <span class="keyword">new</span> Comparator&lt;GroupItemInfo&gt;()&#123;</div><div class="line">                @Override</div><div class="line">                public int compare(GroupItemInfo o1, GroupItemInfo o2) &#123;</div><div class="line">                    <span class="keyword">if</span>(o1.getSum() == o2.getSum())&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(o1.getSum() &gt; o2.getSum())&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">                    &#125;<span class="keyword">else</span>&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * 找回前10名</div><div class="line">         * @param startDate</div><div class="line">         * @param endDate</div><div class="line">         * @return</div><div class="line">         */</div><div class="line">        public <span class="built_in">String</span> printTop10(long startDate, long endDate)&#123;</div><div class="line">            double allAmount = <span class="number">0.0</span>;</div><div class="line">            <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, GroupItemInfo&gt; groupMap = <span class="keyword">new</span> HashMap&lt;<span class="built_in">String</span>, GroupItemInfo&gt;();</div><div class="line">            <span class="keyword">for</span>(GroupItemInfo item : itemList)&#123;</div><div class="line">                <span class="built_in">String</span> key = item.getItemName();</div><div class="line">                allAmount += item.getSum();</div><div class="line">                <span class="keyword">if</span>(groupMap.containsKey(key))&#123;</div><div class="line">                    GroupItemInfo oldItem = groupMap.get(key);</div><div class="line">                    oldItem.setCount(oldItem.getCount() + item.getCount());</div><div class="line">                    oldItem.setSum(oldItem.getSum() + item.getSum());</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    groupMap.put(key, item);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            List&lt;GroupItemInfo&gt; sortedResult = sortBySumDesc(groupMap.values());</div><div class="line">            StringBuffer sb =  <span class="keyword">new</span> StringBuffer();</div><div class="line">            <span class="keyword">for</span>(int i = <span class="number">1</span>; i &lt;= <span class="number">10</span> ; i++)&#123;</div><div class="line">                <span class="keyword">if</span>(sortedResult.size() &gt;= i &amp;&amp; sortedResult.get(i<span class="number">-1</span>) != <span class="literal">null</span>)&#123;</div><div class="line">                    GroupItemInfo oneItem = sortedResult.get(i<span class="number">-1</span>);</div><div class="line">                    sb.append(startDate).append(<span class="string">","</span>).append(endDate).append(<span class="string">","</span>).append(itemType).append(<span class="string">","</span>).append(oneItem.getItemName()).append(<span class="string">","</span>)</div><div class="line">                            .append(oneItem.getCount()).append(<span class="string">","</span>).append(oneItem.getPrice()).append(<span class="string">","</span>).append(oneItem.getSum()).append(<span class="string">","</span>).append(allAmount)</div><div class="line">                            .append(<span class="string">","</span>).append(i).append(<span class="string">"\n"</span>);</div><div class="line">                &#125;<span class="keyword">else</span>&#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> sb.toString();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupItemInfo</span></span>&#123;</div><div class="line">        private long transactionDate;</div><div class="line">        private <span class="built_in">String</span> itemName;</div><div class="line">        private int count;</div><div class="line">        private double price;</div><div class="line">        private double sum;</div><div class="line">        public GroupItemInfo()&#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        public GroupItemInfo(long transactionDate, <span class="built_in">String</span> itemName, int count, double price,</div><div class="line">                             double sum) &#123;</div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line">            <span class="keyword">this</span>.count = count;</div><div class="line">            <span class="keyword">this</span>.price = price;</div><div class="line">            <span class="keyword">this</span>.sum = sum;</div><div class="line">        &#125;</div><div class="line">        public long getTransactionDate() &#123;</div><div class="line">            <span class="keyword">return</span> transactionDate;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">        &#125;</div><div class="line">        public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">            <span class="keyword">return</span> itemName;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line">        &#125;</div><div class="line">        public int getCount() &#123;</div><div class="line">            <span class="keyword">return</span> count;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setCount(int count) &#123;</div><div class="line">            <span class="keyword">this</span>.count = count;</div><div class="line">        &#125;</div><div class="line">        public double getPrice() &#123;</div><div class="line">            <span class="keyword">return</span> price;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setPrice(double price) &#123;</div><div class="line">            <span class="keyword">this</span>.price = price;</div><div class="line">        &#125;</div><div class="line">        public double getSum() &#123;</div><div class="line">            <span class="keyword">return</span> sum;</div><div class="line">        &#125;</div><div class="line">        public <span class="keyword">void</span> setSum(double sum) &#123;</div><div class="line">            <span class="keyword">this</span>.sum = sum;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUser</span> </span>&#123;</div><div class="line">        private <span class="built_in">String</span> userName;</div><div class="line">        private <span class="built_in">String</span> itemName;</div><div class="line">        private long transactionDate;</div><div class="line">        private int quantity;</div><div class="line">        private <span class="built_in">String</span> userAddress;</div><div class="line">        private <span class="built_in">String</span> gender;</div><div class="line">        private int age;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserName() &#123;</div><div class="line">            <span class="keyword">return</span> userName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line">            <span class="keyword">this</span>.userName = userName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">            <span class="keyword">return</span> itemName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public long getTransactionDate() &#123;</div><div class="line">            <span class="keyword">return</span> transactionDate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public int getQuantity() &#123;</div><div class="line">            <span class="keyword">return</span> quantity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line">            <span class="keyword">this</span>.quantity = quantity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line">            <span class="keyword">return</span> userAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line">            <span class="keyword">this</span>.userAddress = userAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getGender() &#123;</div><div class="line">            <span class="keyword">return</span> gender;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public int getAge() &#123;</div><div class="line">            <span class="keyword">return</span> age;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUser fromOrder(Order order) &#123;</div><div class="line">            OrderUser orderUser = <span class="keyword">new</span> OrderUser();</div><div class="line">            <span class="keyword">if</span>(order == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> orderUser;</div><div class="line">            &#125;</div><div class="line">            orderUser.userName = order.getUserName();</div><div class="line">            orderUser.itemName = order.getItemName();</div><div class="line">            orderUser.transactionDate = order.getTransactionDate();</div><div class="line">            orderUser.quantity = order.getQuantity();</div><div class="line">            <span class="keyword">return</span> orderUser;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUser fromOrderUser(Order order, User user) &#123;</div><div class="line">            OrderUser orderUser = fromOrder(order);</div><div class="line">            <span class="keyword">if</span>(user == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> orderUser;</div><div class="line">            &#125;</div><div class="line">            orderUser.gender = user.getGender();</div><div class="line">            orderUser.age = user.getAge();</div><div class="line">            orderUser.userAddress = user.getAddress();</div><div class="line">            <span class="keyword">return</span> orderUser;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUserItem</span> </span>&#123;</div><div class="line">        private <span class="built_in">String</span> userName;</div><div class="line">        private <span class="built_in">String</span> itemName;</div><div class="line">        private long transactionDate;</div><div class="line">        private int quantity;</div><div class="line">        private <span class="built_in">String</span> userAddress;</div><div class="line">        private <span class="built_in">String</span> gender;</div><div class="line">        private int age;</div><div class="line">        private <span class="built_in">String</span> itemAddress;</div><div class="line">        private <span class="built_in">String</span> itemType;</div><div class="line">        private double itemPrice;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserName() &#123;</div><div class="line">            <span class="keyword">return</span> userName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line">            <span class="keyword">this</span>.userName = userName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">            <span class="keyword">return</span> itemName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public long getTransactionDate() &#123;</div><div class="line">            <span class="keyword">return</span> transactionDate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public int getQuantity() &#123;</div><div class="line">            <span class="keyword">return</span> quantity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line">            <span class="keyword">this</span>.quantity = quantity;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line">            <span class="keyword">return</span> userAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line">            <span class="keyword">this</span>.userAddress = userAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getGender() &#123;</div><div class="line">            <span class="keyword">return</span> gender;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public int getAge() &#123;</div><div class="line">            <span class="keyword">return</span> age;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemAddress() &#123;</div><div class="line">            <span class="keyword">return</span> itemAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemAddress(<span class="built_in">String</span> itemAddress) &#123;</div><div class="line">            <span class="keyword">this</span>.itemAddress = itemAddress;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemType() &#123;</div><div class="line">            <span class="keyword">return</span> itemType;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemType(<span class="built_in">String</span> itemType) &#123;</div><div class="line">            <span class="keyword">this</span>.itemType = itemType;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public double getItemPrice() &#123;</div><div class="line">            <span class="keyword">return</span> itemPrice;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemPrice(double itemPrice) &#123;</div><div class="line">            <span class="keyword">this</span>.itemPrice = itemPrice;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser) &#123;</div><div class="line">            OrderUserItem orderUserItem = <span class="keyword">new</span> OrderUserItem();</div><div class="line">            <span class="keyword">if</span>(orderUser == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> orderUserItem;</div><div class="line">            &#125;</div><div class="line">            orderUserItem.userName = orderUser.userName;</div><div class="line">            orderUserItem.itemName = orderUser.itemName;</div><div class="line">            orderUserItem.transactionDate = orderUser.transactionDate;</div><div class="line">            orderUserItem.quantity = orderUser.quantity;</div><div class="line">            orderUserItem.userAddress = orderUser.userAddress;</div><div class="line">            orderUserItem.gender = orderUser.gender;</div><div class="line">            orderUserItem.age = orderUser.age;</div><div class="line">            <span class="keyword">return</span> orderUserItem;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser, Item item) &#123;</div><div class="line">            OrderUserItem orderUserItem = fromOrderUser(orderUser);</div><div class="line">            <span class="keyword">if</span>(item == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> orderUserItem;</div><div class="line">            &#125;</div><div class="line">            orderUserItem.itemAddress = item.getAddress();</div><div class="line">            orderUserItem.itemType = item.getType();</div><div class="line">            orderUserItem.itemPrice = item.getPrice();</div><div class="line">            <span class="keyword">return</span> orderUserItem;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/06/kafka stream 实战2/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/06/kafka stream 实战2/" itemprop="url">
                  kafka stream 实战2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-06T11:52:55+08:00">
                2016-12-06
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/06/kafka stream 实战2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/06/kafka stream 实战2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>场景： 在上一个示例（算出用户与商品同地址的订单中，男女分别总共花了多少钱）的基础上，算出不同地区（用户地址），不同性别的订单数及商品总数和总金额。输出结果schema如下 </p>
<p>地区（用户地区，如SH），性别，订单总数，商品总数，总金额</p>
<p>示例输出</p>
<p>SH, male, 3, 4, 188888.88</p>
<p>BJ, femail, 5, 8, 288888.88 </p>
<p>推演过程：<br><img src="http://oh6ybr0jg.bkt.clouddn.com/%E5%AE%9E%E6%88%982%E6%8E%A8%E6%BC%94.png" alt="此处输入图片的描述"></p>
<p>实现代码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div></pre></td><td class="code"><pre><div class="line">package com.jasongj.kafka.stream;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serdes;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KafkaStreams;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KeyValue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.StreamsConfig;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStream;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStreamBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KTable;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.Item;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.Order;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.model.User;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.serdes.SerdesFactory;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.jasongj.kafka.stream.timeextractor.OrderTimestampExtractor;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by root on 17-1-5.</div><div class="line"> */</div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Di9KeZuoYe</span> </span>&#123;</div><div class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException, InterruptedException &#123;</div><div class="line"></div><div class="line">        Properties props = <span class="keyword">new</span> Properties();</div><div class="line"></div><div class="line">        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">"streams-purchase-analysis2"</span>);</div><div class="line"></div><div class="line">        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"jenick.com:9092"</span>);</div><div class="line">        props.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, <span class="string">"jenick.com:2181"</span>);</div><div class="line"></div><div class="line">        props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line"></div><div class="line">        props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line"></div><div class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"earliest"</span>);</div><div class="line"></div><div class="line">        props.put(StreamsConfig.TIMESTAMP_EXTRACTOR_CLASS_CONFIG, OrderTimestampExtractor.class);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        KStreamBuilder streamBuilder = <span class="keyword">new</span> KStreamBuilder();</div><div class="line"></div><div class="line">        KStream&lt;<span class="built_in">String</span>, Order&gt; orderStream = streamBuilder.stream(Serdes.String(), SerdesFactory.serdFrom(Order.class), <span class="string">"orders"</span>);</div><div class="line"></div><div class="line">        KTable&lt;<span class="built_in">String</span>, User&gt; userTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(User.class), <span class="string">"users"</span>, <span class="string">"users-state-store"</span>);</div><div class="line"></div><div class="line">        KTable&lt;<span class="built_in">String</span>, Item&gt; itemTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(Item.class), <span class="string">"items"</span>, <span class="string">"items-state-store"</span>);</div><div class="line"></div><div class="line">        KTable&lt;AddrSex, OrderMoney&gt; kTable = orderStream</div><div class="line"></div><div class="line">                .leftJoin(userTable, (Order order, User user) -&gt; OrderUser.fromOrderUser(order, user), Serdes.String(), SerdesFactory.serdFrom(Order.class))</div><div class="line"></div><div class="line">                .filter((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; orderUser.userAddress != <span class="literal">null</span>)</div><div class="line"></div><div class="line">                .map((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, OrderUser&gt;(orderUser.itemName, orderUser))</div><div class="line"></div><div class="line">                .through(Serdes.String(), SerdesFactory.serdFrom(OrderUser.class), (<span class="built_in">String</span> key, OrderUser orderUser, int numPartitions) -&gt; (orderUser.getItemName().hashCode() &amp; <span class="number">0x7FFFFFFF</span>) % numPartitions, <span class="string">"orderuser-repartition-by-item"</span>)</div><div class="line"></div><div class="line">                .leftJoin(itemTable, (OrderUser orderUser, Item item) -&gt; OrderUserItem.fromOrderUser(orderUser, item), Serdes.String(), SerdesFactory.serdFrom(OrderUser.class))</div><div class="line"></div><div class="line">                .filter((<span class="built_in">String</span> item, OrderUserItem orderUserItem) -&gt; StringUtils.compare(orderUserItem.userAddress, orderUserItem.itemAddress) == <span class="number">0</span>)</div><div class="line"></div><div class="line">                .map((<span class="built_in">String</span> item, OrderUserItem orderUserItem) -&gt; KeyValue.&lt;AddrSex, OrderMoney&gt;pair(<span class="keyword">new</span> AddrSex(orderUserItem.userAddress, orderUserItem.gender), OrderMoney.fromItem(orderUserItem.quantity, orderUserItem.itemPrice)))</div><div class="line"></div><div class="line">                .groupByKey(SerdesFactory.serdFrom(AddrSex.class), SerdesFactory.serdFrom(OrderMoney.class))</div><div class="line"></div><div class="line">                .reduce((OrderMoney v1, OrderMoney v2) -&gt; <span class="keyword">new</span> OrderMoney(v1.orderNum + v2.orderNum, v1.itemNum + v2.itemNum, v1.TotalMoney + v2.TotalMoney), <span class="string">"gender-amount-state-store"</span>);</div><div class="line"></div><div class="line">        kTable</div><div class="line"></div><div class="line">                .toStream()</div><div class="line"></div><div class="line">                .map((AddrSex addrSex, OrderMoney orderMoney) -&gt; <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;(addrSex.toString(), orderMoney.toString()))</div><div class="line"></div><div class="line">                .to(<span class="string">"gender-amount"</span>);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        KafkaStreams kafkaStreams = <span class="keyword">new</span> KafkaStreams(streamBuilder, props);</div><div class="line"></div><div class="line">        kafkaStreams.cleanUp();</div><div class="line"></div><div class="line">        kafkaStreams.start();</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        System.in.read();</div><div class="line"></div><div class="line">        kafkaStreams.close();</div><div class="line"></div><div class="line">        kafkaStreams.cleanUp();</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUser</span> </span>&#123;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> userName;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> itemName;</div><div class="line"></div><div class="line">        private long transactionDate;</div><div class="line"></div><div class="line">        private int quantity;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> userAddress;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> gender;</div><div class="line"></div><div class="line">        private int age;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserName() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> userName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.userName = userName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemName() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public long getTransactionDate() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> transactionDate;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getQuantity() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> quantity;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.quantity = quantity;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> userAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.userAddress = userAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getGender() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getAge() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> age;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUser fromOrder(Order order) &#123;</div><div class="line"></div><div class="line">            OrderUser orderUser = <span class="keyword">new</span> OrderUser();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (order == <span class="literal">null</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> orderUser;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            orderUser.userName = order.getUserName();</div><div class="line"></div><div class="line">            orderUser.itemName = order.getItemName();</div><div class="line"></div><div class="line">            orderUser.transactionDate = order.getTransactionDate();</div><div class="line"></div><div class="line">            orderUser.quantity = order.getQuantity();</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderUser;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUser fromOrderUser(Order order, User user) &#123;</div><div class="line"></div><div class="line">            OrderUser orderUser = fromOrder(order);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> orderUser;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            orderUser.gender = user.getGender();</div><div class="line"></div><div class="line">            orderUser.age = user.getAge();</div><div class="line"></div><div class="line">            orderUser.userAddress = user.getAddress();</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderUser;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUserItem</span> </span>&#123;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> userName;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> itemName;</div><div class="line"></div><div class="line">        private long transactionDate;</div><div class="line"></div><div class="line">        private int quantity;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> userAddress;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> gender;</div><div class="line"></div><div class="line">        private int age;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> itemAddress;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> itemType;</div><div class="line"></div><div class="line">        private double itemPrice;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserName() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> userName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.userName = userName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemName() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemName = itemName;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public long getTransactionDate() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> transactionDate;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getQuantity() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> quantity;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.quantity = quantity;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> userAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.userAddress = userAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getGender() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getAge() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> age;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.age = age;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemAddress() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemAddress(<span class="built_in">String</span> itemAddress) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemAddress = itemAddress;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getItemType() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemType;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemType(<span class="built_in">String</span> itemType) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemType = itemType;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public double getItemPrice() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemPrice;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemPrice(double itemPrice) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemPrice = itemPrice;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser) &#123;</div><div class="line"></div><div class="line">            OrderUserItem orderUserItem = <span class="keyword">new</span> OrderUserItem();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (orderUser == <span class="literal">null</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> orderUserItem;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            orderUserItem.userName = orderUser.userName;</div><div class="line"></div><div class="line">            orderUserItem.itemName = orderUser.itemName;</div><div class="line"></div><div class="line">            orderUserItem.transactionDate = orderUser.transactionDate;</div><div class="line"></div><div class="line">            orderUserItem.quantity = orderUser.quantity;</div><div class="line"></div><div class="line">            orderUserItem.userAddress = orderUser.userAddress;</div><div class="line"></div><div class="line">            orderUserItem.gender = orderUser.gender;</div><div class="line"></div><div class="line">            orderUserItem.age = orderUser.age;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderUserItem;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser, Item item) &#123;</div><div class="line"></div><div class="line">            OrderUserItem orderUserItem = fromOrderUser(orderUser);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (item == <span class="literal">null</span>) &#123;</div><div class="line"></div><div class="line">                <span class="keyword">return</span> orderUserItem;</div><div class="line"></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            orderUserItem.itemAddress = item.getAddress();</div><div class="line"></div><div class="line">            orderUserItem.itemType = item.getType();</div><div class="line"></div><div class="line">            orderUserItem.itemPrice = item.getPrice();</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderUserItem;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddrSex</span> </span>&#123;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> addr;</div><div class="line"></div><div class="line">        private <span class="built_in">String</span> gender;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public AddrSex() &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public AddrSex(<span class="built_in">String</span> addr, <span class="built_in">String</span> gender) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.addr = addr;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getAddr() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> addr;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setAddr(<span class="built_in">String</span> addr) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.addr = addr;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="built_in">String</span> getGender() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.gender = gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        @Override</div><div class="line"></div><div class="line">        public boolean equals(<span class="built_in">Object</span> o) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            AddrSex addrSex = (AddrSex) o;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!addr.equals(addrSex.addr)) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> gender.equals(addrSex.gender);</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        @Override</div><div class="line"></div><div class="line">        public int hashCode() &#123;</div><div class="line"></div><div class="line">            int result = addr.hashCode();</div><div class="line"></div><div class="line">            result = <span class="number">31</span> * result + gender.hashCode();</div><div class="line"></div><div class="line">            <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        @Override</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> toString() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> addr + <span class="string">" "</span> + gender;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderMoney</span> </span>&#123;</div><div class="line"></div><div class="line">        private int orderNum;</div><div class="line"></div><div class="line">        private int itemNum;</div><div class="line"></div><div class="line">        private Double TotalMoney;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public OrderMoney() &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public OrderMoney(int orderNum, int itemNum, Double totalMoney) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.orderNum = orderNum;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemNum = itemNum;</div><div class="line"></div><div class="line">            TotalMoney = totalMoney;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getOrderNum() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderNum;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setOrderNum(int orderNum) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.orderNum = orderNum;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public int getItemNum() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> itemNum;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setItemNum(int itemNum) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">this</span>.itemNum = itemNum;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public Double getTotalMoney() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> TotalMoney;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">void</span> setTotalMoney(Double totalMoney) &#123;</div><div class="line"></div><div class="line">            TotalMoney = totalMoney;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        public <span class="keyword">static</span> OrderMoney fromItem(int quantity, Double itemPrice) &#123;</div><div class="line"></div><div class="line">            OrderMoney orderMoney = <span class="keyword">new</span> OrderMoney();</div><div class="line"></div><div class="line">            orderMoney.setOrderNum(<span class="number">1</span>);</div><div class="line"></div><div class="line">            orderMoney.setItemNum(quantity);</div><div class="line"></div><div class="line">            orderMoney.setTotalMoney((double) quantity * itemPrice);</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderMoney;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        @Override</div><div class="line"></div><div class="line">        public <span class="built_in">String</span> toString() &#123;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> orderNum + <span class="string">" "</span> + itemNum + <span class="string">" "</span> + TotalMoney;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果<br><img src="http://oh6ybr0jg.bkt.clouddn.com/%E7%AC%AC%E4%B9%9D%E8%AF%BE%E4%BD%9C%E4%B8%9A.png" alt="此处输入图片的描述"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/05/kafka stream 实战/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/05/kafka stream 实战/" itemprop="url">
                  kafka stream 实战
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-05T11:13:30+08:00">
                2016-12-05
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/05/kafka stream 实战/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/05/kafka stream 实战/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>场景：目前有三个表：产品表，用户表，订单表。求性别平均消费金额</p>
<p>数据：<br>产品表<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">iphone, BJ, phone, <span class="number">5388.88</span></div><div class="line">ipad, SH, pad, <span class="number">4888.88</span></div><div class="line">iwatch, SZ, watch, <span class="number">2668.88</span></div><div class="line">ipod, GZ, pod, <span class="number">1888.88</span></div></pre></td></tr></table></figure></p>
<p>用户表<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Jack, BJ, male, <span class="number">23</span></div><div class="line">Lily, SH, female, <span class="number">21</span></div><div class="line">Mike, SZ, male, <span class="number">22</span></div><div class="line">Lucy, GZ, female, <span class="number">20</span></div></pre></td></tr></table></figure></p>
<p>订单表<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">Jack, iphone, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span>, <span class="number">3</span></div><div class="line">Jack, ipad, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">02</span>, <span class="number">4</span></div><div class="line">Jack, iwatch, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span>, <span class="number">5</span></div><div class="line">Jack, ipod, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">04</span>, <span class="number">4</span></div><div class="line"></div><div class="line">Lily, ipad, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">06</span>, <span class="number">3</span></div><div class="line">Lily, iwatch, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">07</span>, <span class="number">4</span></div><div class="line">Lily, iphone, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">08</span>, <span class="number">2</span></div><div class="line">Lily, ipod, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">09</span>, <span class="number">3</span></div><div class="line"></div><div class="line">Mike, ipad, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">11</span>, <span class="number">2</span></div><div class="line">Mike, iwatch, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">12</span>, <span class="number">3</span></div><div class="line">Mike, iphone, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">13</span>, <span class="number">4</span></div><div class="line">Mike, ipod, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">14</span>, <span class="number">3</span></div><div class="line"></div><div class="line">Lucy, ipod, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">16</span>, <span class="number">3</span></div><div class="line">Lucy, ipad, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">17</span>, <span class="number">4</span></div><div class="line">Lucy, iwatch, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">18</span>, <span class="number">3</span></div><div class="line">Lucy, iphone, <span class="number">2016</span><span class="number">-11</span><span class="number">-11</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">19</span>, <span class="number">5</span></div></pre></td></tr></table></figure></p>
<p>创建打印类<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.DoubleDeserializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DemoConsumerManualCommit</span> </span>&#123;</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</div><div class="line">		args = <span class="keyword">new</span> <span class="built_in">String</span>[] &#123; <span class="string">"jenick.com:9092"</span>, <span class="string">"gender-amount2"</span>, <span class="string">"group4"</span>, <span class="string">"consumer2"</span> &#125;;</div><div class="line">		<span class="keyword">if</span> (args == <span class="literal">null</span> || args.length != <span class="number">4</span>) &#123;</div><div class="line">			System.err.println(</div><div class="line">					<span class="string">"Usage:\n\tjava -jar kafka_consumer.jar $&#123;bootstrap_server&#125; $&#123;topic_name&#125; $&#123;group_name&#125; $&#123;client_id&#125;"</span>);</div><div class="line">			System.exit(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">String</span> bootstrap = args[<span class="number">0</span>];</div><div class="line">		<span class="built_in">String</span> topic = args[<span class="number">1</span>];</div><div class="line">		<span class="built_in">String</span> groupid = args[<span class="number">2</span>];</div><div class="line">		<span class="built_in">String</span> clientid = args[<span class="number">3</span>];</div><div class="line">		</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(<span class="string">"bootstrap.servers"</span>, bootstrap);</div><div class="line">		props.put(<span class="string">"group.id"</span>, groupid);</div><div class="line">		props.put(<span class="string">"enable.auto.commit"</span>, <span class="string">"false"</span>);</div><div class="line">		props.put(<span class="string">"key.deserializer"</span>, StringDeserializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.deserializer"</span>, DoubleDeserializer.class.getName());</div><div class="line">		props.put(<span class="string">"max.poll.interval.ms"</span>, <span class="string">"300000"</span>);</div><div class="line">		props.put(<span class="string">"max.poll.records"</span>, <span class="string">"500"</span>);</div><div class="line">		props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"earliest"</span>);</div><div class="line">		KafkaConsumer&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</div><div class="line">		consumer.subscribe(Arrays.asList(topic));</div><div class="line">		AtomicLong atomicLong = <span class="keyword">new</span> AtomicLong();</div><div class="line">		<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">			ConsumerRecords&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; records = consumer.poll(<span class="number">100</span>);</div><div class="line">			records.forEach(record -&gt; &#123;</div><div class="line">				System.out.printf(<span class="string">"client : %s , topic: %s , partition: %d , offset = %d, key = %s, value = %s%n"</span>,</div><div class="line">						clientid, record.topic(), record.partition(), record.offset(), record.key(), record.value());</div><div class="line">				<span class="keyword">if</span> (atomicLong.get() % <span class="number">10</span> == <span class="number">0</span>) &#123;</div><div class="line"><span class="comment">//					consumer.commitSync();</span></div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TimestampExtractor<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"><span class="keyword">import</span> java.time.ZoneOffset;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.processor.TimestampExtractor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.JsonNode;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Item;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Order;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.User;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderTimestampExtractor</span> <span class="title">implements</span> <span class="title">TimestampExtractor</span> </span>&#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public long extract(ConsumerRecord&lt;<span class="built_in">Object</span>, <span class="built_in">Object</span>&gt; record) &#123;</div><div class="line">		<span class="built_in">Object</span> value = record.value();</div><div class="line">		<span class="keyword">if</span> (record.value() <span class="keyword">instanceof</span> Order) &#123;</div><div class="line">			Order order = (Order) value;</div><div class="line">			<span class="keyword">return</span> order.getTransactionDate();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> JsonNode) &#123;</div><div class="line">			<span class="keyword">return</span> ((JsonNode) record.value()).get(<span class="string">"transactionDate"</span>).longValue();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> Item) &#123;</div><div class="line">			<span class="keyword">return</span> LocalDateTime.of(<span class="number">2015</span>, <span class="number">12</span>,<span class="number">11</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">10</span>).toEpochSecond(ZoneOffset.UTC) * <span class="number">1000</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> User) &#123;</div><div class="line">			<span class="keyword">return</span> LocalDateTime.of(<span class="number">2015</span>, <span class="number">12</span>,<span class="number">11</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>).toEpochSecond(ZoneOffset.UTC) * <span class="number">1000</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> LocalDateTime.of(<span class="number">2015</span>, <span class="number">11</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>).toEpochSecond(ZoneOffset.UTC) * <span class="number">1000</span>;</div><div class="line"><span class="comment">//		throw new IllegalArgumentException("OrderTimestampExtractor cannot recognize the record value " + record.value());</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>创建stream处理类<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serdes;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KafkaStreams;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KeyValue;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.StreamsConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStream;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KStreamBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.kstream.KTable;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Item;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Order;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.User;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.serdes.SerdesFactory;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.timeextractor.OrderTimestampExtractor;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PurchaseAnalysis</span> </span>&#123;</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException, InterruptedException &#123;</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">"streams-purchase-analysis2"</span>);</div><div class="line">		props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"jenick.com:9092"</span>);</div><div class="line">		props.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, <span class="string">"jenick.com:2181"</span>);</div><div class="line">		props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line">		props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line">		props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"earliest"</span>);</div><div class="line">		props.put(StreamsConfig.TIMESTAMP_EXTRACTOR_CLASS_CONFIG, OrderTimestampExtractor.class);</div><div class="line"></div><div class="line">		KStreamBuilder streamBuilder = <span class="keyword">new</span> KStreamBuilder();</div><div class="line">		KStream&lt;<span class="built_in">String</span>, Order&gt; orderStream = streamBuilder.stream(Serdes.String(), SerdesFactory.serdFrom(Order.class), <span class="string">"orders"</span>);</div><div class="line">		KTable&lt;<span class="built_in">String</span>, User&gt; userTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(User.class), <span class="string">"users"</span>, <span class="string">"users-state-store"</span>);</div><div class="line">		KTable&lt;<span class="built_in">String</span>, Item&gt; itemTable = streamBuilder.table(Serdes.String(), SerdesFactory.serdFrom(Item.class), <span class="string">"items2"</span>, <span class="string">"items-state-store"</span>);</div><div class="line"><span class="comment">//		itemTable.toStream().foreach((String itemName, Item item) -&gt; System.out.printf("Item info %s-%s-%s-%s\n", item.getItemName(), item.getAddress(), item.getType(), item.getPrice()));</span></div><div class="line">		KTable&lt;<span class="built_in">String</span>, Double&gt; kTable = orderStream</div><div class="line">				.leftJoin(userTable, (Order order, User user) -&gt; OrderUser.fromOrderUser(order, user), Serdes.String(), SerdesFactory.serdFrom(Order.class))</div><div class="line">				.filter((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; orderUser.userAddress != <span class="literal">null</span>)</div><div class="line">				.map((<span class="built_in">String</span> userName, OrderUser orderUser) -&gt; <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, OrderUser&gt;(orderUser.itemName, orderUser))</div><div class="line">				.through(Serdes.String(), SerdesFactory.serdFrom(OrderUser.class), (<span class="built_in">String</span> key, OrderUser orderUser, int numPartitions) -&gt; (orderUser.getItemName().hashCode() &amp; <span class="number">0x7FFFFFFF</span>) % numPartitions, <span class="string">"orderuser-repartition-by-item2"</span>)</div><div class="line">				.leftJoin(itemTable, (OrderUser orderUser, Item item) -&gt; OrderUserItem.fromOrderUser(orderUser, item), Serdes.String(), SerdesFactory.serdFrom(OrderUser.class))</div><div class="line">				.filter((<span class="built_in">String</span> item, OrderUserItem orderUserItem) -&gt; StringUtils.compare(orderUserItem.userAddress, orderUserItem.itemAddress) == <span class="number">0</span>)</div><div class="line"><span class="comment">//				.foreach((String itemName, OrderUserItem orderUserItem) -&gt; System.out.printf("%s-%s-%s-%s\n", itemName, orderUserItem.itemAddress, orderUserItem.userName, orderUserItem.userAddress))</span></div><div class="line">				.map((<span class="built_in">String</span> item, OrderUserItem orderUserItem) -&gt; KeyValue.&lt;<span class="built_in">String</span>, Double&gt;pair(orderUserItem.gender, (Double)(orderUserItem.quantity * orderUserItem.itemPrice)))</div><div class="line">				.groupByKey(Serdes.String(), Serdes.Double())</div><div class="line">				.reduce((Double v1, Double v2) -&gt; v1 + v2, <span class="string">"gender-amount-state-store"</span>);</div><div class="line"><span class="comment">//		kTable.foreach((str, dou) -&gt; System.out.printf("%s-%s\n", str, dou));</span></div><div class="line">		kTable</div><div class="line">			.toStream()</div><div class="line">			.map((<span class="built_in">String</span> gender, Double total) -&gt; <span class="keyword">new</span> KeyValue&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt;(gender, <span class="built_in">String</span>.valueOf(total)))</div><div class="line">			.to(<span class="string">"gender-amount2"</span>);</div><div class="line">		</div><div class="line">		KafkaStreams kafkaStreams = <span class="keyword">new</span> KafkaStreams(streamBuilder, props);</div><div class="line">		kafkaStreams.cleanUp();</div><div class="line">		kafkaStreams.start();</div><div class="line">		</div><div class="line">		System.in.read();</div><div class="line">		kafkaStreams.close();</div><div class="line">		kafkaStreams.cleanUp();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUser</span> </span>&#123;</div><div class="line">		private <span class="built_in">String</span> userName;</div><div class="line">		private <span class="built_in">String</span> itemName;</div><div class="line">		private long transactionDate;</div><div class="line">		private int quantity;</div><div class="line">		private <span class="built_in">String</span> userAddress;</div><div class="line">		private <span class="built_in">String</span> gender;</div><div class="line">		private int age;</div><div class="line">		</div><div class="line">		public <span class="built_in">String</span> getUserName() &#123;</div><div class="line">			<span class="keyword">return</span> userName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line">			<span class="keyword">this</span>.userName = userName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">			<span class="keyword">return</span> itemName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">			<span class="keyword">this</span>.itemName = itemName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public long getTransactionDate() &#123;</div><div class="line">			<span class="keyword">return</span> transactionDate;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">			<span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public int getQuantity() &#123;</div><div class="line">			<span class="keyword">return</span> quantity;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line">			<span class="keyword">this</span>.quantity = quantity;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line">			<span class="keyword">return</span> userAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line">			<span class="keyword">this</span>.userAddress = userAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getGender() &#123;</div><div class="line">			<span class="keyword">return</span> gender;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line">			<span class="keyword">this</span>.gender = gender;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public int getAge() &#123;</div><div class="line">			<span class="keyword">return</span> age;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line">			<span class="keyword">this</span>.age = age;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">static</span> OrderUser fromOrder(Order order) &#123;</div><div class="line">			OrderUser orderUser = <span class="keyword">new</span> OrderUser();</div><div class="line">			<span class="keyword">if</span>(order == <span class="literal">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> orderUser;</div><div class="line">			&#125;</div><div class="line">			orderUser.userName = order.getUserName();</div><div class="line">			orderUser.itemName = order.getItemName();</div><div class="line">			orderUser.transactionDate = order.getTransactionDate();</div><div class="line">			orderUser.quantity = order.getQuantity();</div><div class="line">			<span class="keyword">return</span> orderUser;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		public <span class="keyword">static</span> OrderUser fromOrderUser(Order order, User user) &#123;</div><div class="line">			OrderUser orderUser = fromOrder(order);</div><div class="line">			<span class="keyword">if</span>(user == <span class="literal">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> orderUser;</div><div class="line">			&#125;</div><div class="line">			orderUser.gender = user.getGender();</div><div class="line">			orderUser.age = user.getAge();</div><div class="line">			orderUser.userAddress = user.getAddress();</div><div class="line">			<span class="keyword">return</span> orderUser;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderUserItem</span> </span>&#123;</div><div class="line">		private <span class="built_in">String</span> userName;</div><div class="line">		private <span class="built_in">String</span> itemName;</div><div class="line">		private long transactionDate;</div><div class="line">		private int quantity;</div><div class="line">		private <span class="built_in">String</span> userAddress;</div><div class="line">		private <span class="built_in">String</span> gender;</div><div class="line">		private int age;</div><div class="line">		private <span class="built_in">String</span> itemAddress;</div><div class="line">		private <span class="built_in">String</span> itemType;</div><div class="line">		private double itemPrice;</div><div class="line">		</div><div class="line">		public <span class="built_in">String</span> getUserName() &#123;</div><div class="line">			<span class="keyword">return</span> userName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line">			<span class="keyword">this</span>.userName = userName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">			<span class="keyword">return</span> itemName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">			<span class="keyword">this</span>.itemName = itemName;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public long getTransactionDate() &#123;</div><div class="line">			<span class="keyword">return</span> transactionDate;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">			<span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public int getQuantity() &#123;</div><div class="line">			<span class="keyword">return</span> quantity;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line">			<span class="keyword">this</span>.quantity = quantity;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getUserAddress() &#123;</div><div class="line">			<span class="keyword">return</span> userAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setUserAddress(<span class="built_in">String</span> userAddress) &#123;</div><div class="line">			<span class="keyword">this</span>.userAddress = userAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getGender() &#123;</div><div class="line">			<span class="keyword">return</span> gender;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line">			<span class="keyword">this</span>.gender = gender;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public int getAge() &#123;</div><div class="line">			<span class="keyword">return</span> age;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line">			<span class="keyword">this</span>.age = age;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getItemAddress() &#123;</div><div class="line">			<span class="keyword">return</span> itemAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setItemAddress(<span class="built_in">String</span> itemAddress) &#123;</div><div class="line">			<span class="keyword">this</span>.itemAddress = itemAddress;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="built_in">String</span> getItemType() &#123;</div><div class="line">			<span class="keyword">return</span> itemType;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setItemType(<span class="built_in">String</span> itemType) &#123;</div><div class="line">			<span class="keyword">this</span>.itemType = itemType;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public double getItemPrice() &#123;</div><div class="line">			<span class="keyword">return</span> itemPrice;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">void</span> setItemPrice(double itemPrice) &#123;</div><div class="line">			<span class="keyword">this</span>.itemPrice = itemPrice;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser) &#123;</div><div class="line">			OrderUserItem orderUserItem = <span class="keyword">new</span> OrderUserItem();</div><div class="line">			<span class="keyword">if</span>(orderUser == <span class="literal">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> orderUserItem;</div><div class="line">			&#125;</div><div class="line">			orderUserItem.userName = orderUser.userName;</div><div class="line">			orderUserItem.itemName = orderUser.itemName;</div><div class="line">			orderUserItem.transactionDate = orderUser.transactionDate;</div><div class="line">			orderUserItem.quantity = orderUser.quantity;</div><div class="line">			orderUserItem.userAddress = orderUser.userAddress;</div><div class="line">			orderUserItem.gender = orderUser.gender;</div><div class="line">			orderUserItem.age = orderUser.age;</div><div class="line">			<span class="keyword">return</span> orderUserItem;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		public <span class="keyword">static</span> OrderUserItem fromOrderUser(OrderUser orderUser, Item item) &#123;</div><div class="line">			OrderUserItem orderUserItem = fromOrderUser(orderUser);</div><div class="line">			<span class="keyword">if</span>(item == <span class="literal">null</span>) &#123;</div><div class="line">				<span class="keyword">return</span> orderUserItem;</div><div class="line">			&#125;</div><div class="line">			orderUserItem.itemAddress = item.getAddress();</div><div class="line">			orderUserItem.itemType = item.getType();</div><div class="line">			orderUserItem.itemPrice = item.getPrice();</div><div class="line">			<span class="keyword">return</span> orderUserItem;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Hash分区<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Partitioner;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.Cluster;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.PartitionInfo;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">HashPartitioner</span> <span class="title">implements</span> <span class="title">Partitioner</span> </span>&#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> configure(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, ?&gt; configs) &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public int partition(<span class="built_in">String</span> topic, <span class="built_in">Object</span> key, byte[] keyBytes, <span class="built_in">Object</span> value, byte[] valueBytes, Cluster cluster) &#123;</div><div class="line">		List&lt;PartitionInfo&gt; partitions = cluster.partitionsForTopic(topic);</div><div class="line">		int numPartitions = partitions.size();</div><div class="line">		<span class="keyword">if</span> (keyBytes != <span class="literal">null</span>) &#123;</div><div class="line">			int hashCode = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (key <span class="keyword">instanceof</span> Integer || key <span class="keyword">instanceof</span> Long) &#123;</div><div class="line">				hashCode = (int) key;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				hashCode = key.hashCode();</div><div class="line">			&#125;</div><div class="line">			hashCode = hashCode &amp; <span class="number">0x7fffffff</span>;</div><div class="line">			<span class="keyword">return</span> hashCode % numPartitions;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> close() &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>序列化<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.errors.SerializationException;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Deserializer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"></div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">GenericDeserializer</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">Deserializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	private Class&lt;T&gt; type;</div><div class="line">	private ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"></div><div class="line">	public GenericDeserializer() &#123;&#125;</div><div class="line">	</div><div class="line">	public GenericDeserializer(Class&lt;T&gt; type) &#123;</div><div class="line">		<span class="keyword">this</span>.type = type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> configure(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, ?&gt; configs, boolean isKey) &#123;</div><div class="line">		<span class="keyword">if</span>(type != <span class="literal">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="built_in">String</span> typeProp = isKey ? <span class="string">"key.deserializer.type"</span> : <span class="string">"value.deserializer.type"</span>;</div><div class="line">		<span class="built_in">String</span> typeName = (<span class="built_in">String</span>)configs.get(typeProp);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			type = (Class&lt;T&gt;)Class.forName(typeName);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Failed to initialize GenericDeserializer for "</span> + typeName, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public T deserialize(<span class="built_in">String</span> topic, byte[] data) &#123;</div><div class="line">		<span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.objectMapper.readValue(data, type);</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> close() &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.errors.SerializationException;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serde;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serializer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.User;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">GenericSerializer</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">Serializer</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	private Class&lt;T&gt; type;</div><div class="line">	private ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</div><div class="line"></div><div class="line">	public GenericSerializer() &#123;&#125;</div><div class="line">	</div><div class="line">	public GenericSerializer(Class&lt;T&gt; type) &#123;</div><div class="line">		<span class="keyword">this</span>.type = type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> configure(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, ?&gt; configs, boolean isKey) &#123;</div><div class="line">		<span class="keyword">if</span>(type != <span class="literal">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">String</span> typeProp = isKey ? <span class="string">"key.serializer.type"</span> : <span class="string">"value.serializer.type"</span>;</div><div class="line">		<span class="built_in">String</span> typeName = (<span class="built_in">String</span>)configs.get(typeProp);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			type = (Class&lt;T&gt;)Class.forName(typeName);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(<span class="string">"Failed to initialize GenericSerializer for "</span> + typeName, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public byte[] serialize(<span class="built_in">String</span> topic, T object) &#123;</div><div class="line">		<span class="keyword">if</span> (object == <span class="literal">null</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.objectMapper.writerFor(type).writeValueAsBytes(object);</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> SerializationException(ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public <span class="keyword">void</span> close() &#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serde;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serdes;</div><div class="line"></div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">SerdesFactory</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * @param &lt;T&gt; The class should have a constructor without any</div><div class="line">	 *        arguments and have setter and getter for every member variable</div><div class="line">	 * @param pojoClass POJO class. </div><div class="line">	 * @return Instance of &#123;@link Serde&#125;</div><div class="line">	 */</div><div class="line">	public <span class="keyword">static</span> &lt;T&gt; Serde&lt;T&gt; serdFrom(Class&lt;T&gt; pojoClass) &#123;</div><div class="line">		<span class="keyword">return</span> Serdes.serdeFrom(<span class="keyword">new</span> GenericSerializer&lt;T&gt;(pojoClass), <span class="keyword">new</span> GenericDeserializer&lt;T&gt;(pojoClass));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>bean对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Item</span> </span>&#123;</div><div class="line">	private <span class="built_in">String</span> itemName;</div><div class="line">	private <span class="built_in">String</span> address;</div><div class="line">	private <span class="built_in">String</span> type;</div><div class="line">	private double price;</div><div class="line"></div><div class="line">	public Item() &#123;&#125;</div><div class="line">	</div><div class="line">	public Item(<span class="built_in">String</span> itemName, <span class="built_in">String</span> address, <span class="built_in">String</span> type, double price) &#123;</div><div class="line">		<span class="keyword">this</span>.itemName = itemName;</div><div class="line">		<span class="keyword">this</span>.address = address;</div><div class="line">		<span class="keyword">this</span>.type = type;</div><div class="line">		<span class="keyword">this</span>.price = price;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">		<span class="keyword">return</span> itemName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">		<span class="keyword">this</span>.itemName = itemName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getAddress() &#123;</div><div class="line">		<span class="keyword">return</span> address;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setAddress(<span class="built_in">String</span> address) &#123;</div><div class="line">		<span class="keyword">this</span>.address = address;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getType() &#123;</div><div class="line">		<span class="keyword">return</span> type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setType(<span class="built_in">String</span> type) &#123;</div><div class="line">		<span class="keyword">this</span>.type = type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public double getPrice() &#123;</div><div class="line">		<span class="keyword">return</span> price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setPrice(double price) &#123;</div><div class="line">		<span class="keyword">this</span>.price = price;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</div><div class="line"></div><div class="line">	private <span class="built_in">String</span> userName;</div><div class="line">	private <span class="built_in">String</span> itemName;</div><div class="line">	private long transactionDate;</div><div class="line">	private int quantity;</div><div class="line"></div><div class="line">	public Order() &#123;&#125;</div><div class="line">	</div><div class="line">	public Order(<span class="built_in">String</span> userName, <span class="built_in">String</span> itemName, long transactionDate, int quantity) &#123;</div><div class="line">		<span class="keyword">this</span>.userName = userName;</div><div class="line">		<span class="keyword">this</span>.itemName = itemName;</div><div class="line">		<span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">		<span class="keyword">this</span>.quantity = quantity;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getUserName() &#123;</div><div class="line">		<span class="keyword">return</span> userName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setUserName(<span class="built_in">String</span> userName) &#123;</div><div class="line">		<span class="keyword">this</span>.userName = userName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getItemName() &#123;</div><div class="line">		<span class="keyword">return</span> itemName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setItemName(<span class="built_in">String</span> itemName) &#123;</div><div class="line">		<span class="keyword">this</span>.itemName = itemName;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public long getTransactionDate() &#123;</div><div class="line">		<span class="keyword">return</span> transactionDate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setTransactionDate(long transactionDate) &#123;</div><div class="line">		<span class="keyword">this</span>.transactionDate = transactionDate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public int getQuantity() &#123;</div><div class="line">		<span class="keyword">return</span> quantity;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setQuantity(int quantity) &#123;</div><div class="line">		<span class="keyword">this</span>.quantity = quantity;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	private <span class="built_in">String</span> name;</div><div class="line">	private <span class="built_in">String</span> address;</div><div class="line">	private <span class="built_in">String</span> gender;</div><div class="line">	private int age;</div><div class="line"></div><div class="line">	public User() &#123;&#125;</div><div class="line">	</div><div class="line">	public User(<span class="built_in">String</span> name, <span class="built_in">String</span> address, <span class="built_in">String</span> gender, int age) &#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.address = address;</div><div class="line">		<span class="keyword">this</span>.gender = gender;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="built_in">String</span> getName() &#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setName(<span class="built_in">String</span> name) &#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getAddress() &#123;</div><div class="line">		<span class="keyword">return</span> address;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setAddress(<span class="built_in">String</span> address) &#123;</div><div class="line">		<span class="keyword">this</span>.address = address;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="built_in">String</span> getGender() &#123;</div><div class="line">		<span class="keyword">return</span> gender;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setGender(<span class="built_in">String</span> gender) &#123;</div><div class="line">		<span class="keyword">this</span>.gender = gender;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public int getAge() &#123;</div><div class="line">		<span class="keyword">return</span> age;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public <span class="keyword">void</span> setAge(int age) &#123;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>用户生产者<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.stream.Collectors;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.kafka.producer.HashPartitioner;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.User;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.serdes.GenericSerializer;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserProducer</span> </span>&#123;</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"jenick.com:9092"</span>);</div><div class="line">		props.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);</div><div class="line">		props.put(<span class="string">"retries"</span>, <span class="number">3</span>);</div><div class="line">		props.put(<span class="string">"batch.size"</span>, <span class="number">16384</span>);</div><div class="line">		props.put(<span class="string">"linger.ms"</span>, <span class="number">1</span>);</div><div class="line">		props.put(<span class="string">"buffer.memory"</span>, <span class="number">33554432</span>);</div><div class="line">		props.put(<span class="string">"key.serializer"</span>, StringSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer"</span>, GenericSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer.type"</span>, User.class.getName());</div><div class="line">		props.put(<span class="string">"partitioner.class"</span>, HashPartitioner.class.getName());</div><div class="line"></div><div class="line">		Producer&lt;<span class="built_in">String</span>, User&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;<span class="built_in">String</span>, User&gt;(props);</div><div class="line">		List&lt;User&gt; users = readUser();</div><div class="line">		users.forEach((User user) -&gt; producer.send(<span class="keyword">new</span> ProducerRecord&lt;<span class="built_in">String</span>, User&gt;(<span class="string">"users"</span>, user.getName(), user)));</div><div class="line">		producer.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> List&lt;User&gt; readUser() throws IOException &#123;</div><div class="line">		List&lt;<span class="built_in">String</span>&gt; lines = IOUtils.readLines(OrderProducer.class.getResourceAsStream(<span class="string">"/users.csv"</span>), Charset.forName(<span class="string">"UTF-8"</span>));</div><div class="line">		List&lt;User&gt; users = lines.stream()</div><div class="line">			.filter(StringUtils::isNoneBlank)</div><div class="line">			.map((<span class="built_in">String</span> line) -&gt; line.split(<span class="string">"\\s*,\\s*"</span>))</div><div class="line">			.filter((<span class="built_in">String</span>[] values) -&gt; values.length == <span class="number">4</span>)</div><div class="line">			.map((<span class="built_in">String</span>[] values) -&gt; <span class="keyword">new</span> User(values[<span class="number">0</span>], values[<span class="number">1</span>], values[<span class="number">2</span>], Integer.parseInt(values[<span class="number">3</span>])))</div><div class="line">			.collect(Collectors.toList());</div><div class="line">		<span class="keyword">return</span> users;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>产品生产者<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.stream.Collectors;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.kafka.producer.HashPartitioner;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Item;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.serdes.GenericSerializer;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ItemProducer</span> </span>&#123;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"jenick.com:9092"</span>);</div><div class="line">		props.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);</div><div class="line">		props.put(<span class="string">"retries"</span>, <span class="number">3</span>);</div><div class="line">		props.put(<span class="string">"batch.size"</span>, <span class="number">16384</span>);</div><div class="line">		props.put(<span class="string">"linger.ms"</span>, <span class="number">1</span>);</div><div class="line">		props.put(<span class="string">"buffer.memory"</span>, <span class="number">33554432</span>);</div><div class="line">		props.put(<span class="string">"key.serializer"</span>, StringSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer"</span>, GenericSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer.type"</span>, Item.class.getName());</div><div class="line">		props.put(<span class="string">"partitioner.class"</span>, HashPartitioner.class.getName());</div><div class="line"></div><div class="line">		Producer&lt;<span class="built_in">String</span>, Item&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;<span class="built_in">String</span>, Item&gt;(props);</div><div class="line">		List&lt;Item&gt; items = readItem();</div><div class="line">		items.forEach((Item item) -&gt; producer.send(<span class="keyword">new</span> ProducerRecord&lt;<span class="built_in">String</span>, Item&gt;(<span class="string">"items2"</span>, item.getItemName(), item)));</div><div class="line">		producer.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> List&lt;Item&gt; readItem() throws IOException &#123;</div><div class="line">		List&lt;<span class="built_in">String</span>&gt; lines = IOUtils.readLines(OrderProducer.class.getResourceAsStream(<span class="string">"/items.csv"</span>), Charset.forName(<span class="string">"UTF-8"</span>));</div><div class="line">		List&lt;Item&gt; items = lines.stream()</div><div class="line">			.filter(StringUtils::isNoneBlank)</div><div class="line">			.map((<span class="built_in">String</span> line) -&gt; line.split(<span class="string">"\\s*,\\s*"</span>))</div><div class="line">			.filter((<span class="built_in">String</span>[] values) -&gt; values.length == <span class="number">4</span>)</div><div class="line">			.map((<span class="built_in">String</span>[] values) -&gt; <span class="keyword">new</span> Item(values[<span class="number">0</span>], values[<span class="number">1</span>], values[<span class="number">2</span>], Double.parseDouble(values[<span class="number">3</span>])))</div><div class="line">			.collect(Collectors.toList());</div><div class="line">		<span class="keyword">return</span> items;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>订单生产者<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.io.InputStream;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"><span class="keyword">import</span> java.time.LocalDateTime;</div><div class="line"><span class="keyword">import</span> java.time.ZoneOffset;</div><div class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.stream.Collectors;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</div><div class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.KafkaProducer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.Producer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.producer.ProducerRecord;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.kafka.producer.HashPartitioner;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.model.Order;</div><div class="line"><span class="keyword">import</span> com.kafka.stream.serdes.GenericSerializer;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">OrderProducer</span> </span>&#123;</div><div class="line">	</div><div class="line">	private <span class="keyword">static</span> DateTimeFormatter dataTimeFormatter = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"jenick.com:9092"</span>);</div><div class="line">		props.put(<span class="string">"acks"</span>, <span class="string">"all"</span>);</div><div class="line">		props.put(<span class="string">"retries"</span>, <span class="number">3</span>);</div><div class="line">		props.put(<span class="string">"batch.size"</span>, <span class="number">16384</span>);</div><div class="line">		props.put(<span class="string">"linger.ms"</span>, <span class="number">1</span>);</div><div class="line">		props.put(<span class="string">"buffer.memory"</span>, <span class="number">33554432</span>);</div><div class="line">		props.put(<span class="string">"key.serializer"</span>, StringSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer"</span>, GenericSerializer.class.getName());</div><div class="line">		props.put(<span class="string">"value.serializer.type"</span>, Order.class.getName());</div><div class="line">		props.put(<span class="string">"partitioner.class"</span>, HashPartitioner.class.getName());</div><div class="line"></div><div class="line">		Producer&lt;<span class="built_in">String</span>, Order&gt; producer = <span class="keyword">new</span> KafkaProducer&lt;<span class="built_in">String</span>, Order&gt;(props);</div><div class="line">		List&lt;Order&gt; orders = readOrder();</div><div class="line">		orders.forEach((Order order) -&gt; producer.send(<span class="keyword">new</span> ProducerRecord&lt;<span class="built_in">String</span>, Order&gt;(<span class="string">"orders"</span>, order.getUserName(), order)));</div><div class="line">		producer.close();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public <span class="keyword">static</span> List&lt;Order&gt; readOrder() throws IOException &#123;</div><div class="line">		InputStream inputStream = OrderProducer.class.getResourceAsStream(<span class="string">"/orders.csv"</span>);</div><div class="line">		List&lt;<span class="built_in">String</span>&gt; lines = IOUtils.readLines(inputStream, Charset.forName(<span class="string">"UTF-8"</span>));</div><div class="line">		List&lt;Order&gt; orders = lines.stream()</div><div class="line">			.filter(StringUtils::isNoneBlank)</div><div class="line">			.map((<span class="built_in">String</span> line) -&gt; line.split(<span class="string">"\\s*,\\s*"</span>))</div><div class="line">			.filter((<span class="built_in">String</span>[] values) -&gt; values.length == <span class="number">4</span>)</div><div class="line">			.map((<span class="built_in">String</span>[] values) -&gt; <span class="keyword">new</span> Order(values[<span class="number">0</span>], values[<span class="number">1</span>], LocalDateTime.parse(values[<span class="number">2</span>], dataTimeFormatter).toEpochSecond(ZoneOffset.UTC) * <span class="number">1000</span>, Integer.parseInt(values[<span class="number">3</span>])))</div><div class="line">			.collect(Collectors.toList());</div><div class="line">		<span class="keyword">return</span> orders;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要创建topic如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/root/kafka/kafka1/kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.1</span>/bin/kafka-topics.sh --create --zookeeper jenick.com:<span class="number">2181</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic orders</div><div class="line">/root/kafka/kafka1/kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.1</span>/bin/kafka-topics.sh --create --zookeeper jenick.com:<span class="number">2181</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic items</div><div class="line">/root/kafka/kafka1/kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.1</span>/bin/kafka-topics.sh --create --zookeeper jenick.com:<span class="number">2181</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic users</div><div class="line">/root/kafka/kafka1/kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.1</span>/bin/kafka-topics.sh --create --zookeeper jenick.com:<span class="number">2181</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic gender-amount</div><div class="line">/root/kafka/kafka1/kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.1</span>/bin/kafka-topics.sh --create --zookeeper jenick.com:<span class="number">2181</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic orderuser-repartition-by-item</div></pre></td></tr></table></figure></p>
<p>首先启动DemoConsumerManualCommit，然后启动PurchaseAnalysis<br>先把table的数据创建进去<br>UserProducer、ItemProducer最后启动stream的OrderProducer</p>
<p>运行结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">client : consumer2 , <span class="attr">topic</span>: gender-amount2 , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">0</span>, key = male, value = <span class="number">7.489721245848924E-67</span></div><div class="line">client : consumer2 , <span class="attr">topic</span>: gender-amount2 , <span class="attr">partition</span>: <span class="number">2</span> , offset = <span class="number">0</span>, key = female, value = <span class="number">6.008913963681483E-67</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-kafka " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/03/codis ha/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/03/codis ha/" itemprop="url">
                  codis ha
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-03T22:33:30+08:00">
                2016-12-03
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/03/codis ha/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/03/codis ha/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>启动多个实例：<br>cd /usr/local/codis/src/github.com/CodisLabs/codis<br>[root@zhm1 codis]# ./bin/codis-server /etc/codis/redis6379.conf –protected-mode no<br>[root@zhm1 codis]# ./bin/codis-server /etc/codis/redis6380.conf –protected-mode no<br>[root@zhm1 codis]# ./bin/codis-server /etc/codis/redis6381.conf –protected-mode no<br>[root@zhm1 codis]# ./bin/codis-server /etc/codis/redis6382.conf –protected-mode no</p>
<p>启动zookeeper<br>[root@zhm1 codis]# zkServer.sh start</p>
<p>启动dashboard<br>[root@zhm1 codis]# zkServer.sh startnohup bin/codis-dashboard –ncpu=2 –config=dashboard.conf –log=dashboard.log –log-level=WARN &amp;</p>
<p>启动codis-proxy<br>[root@zhm1 codis]# nohup bin/codis-proxy –ncpu=2 –config=proxy.conf –log =proxy.log –log-level=WARN &amp;</p>
<p>启动codis-fe<br>[root@zhm1 codis]# ./bin/codis-fe –ncpu=2 –log=fe.log –log-level=WARN –dashboard-list=conf/codis.json –listen=192.168.110.129:18090 &amp;</p>
<p>将实例添加到group<br><img src="http://oh6ybr0jg.bkt.clouddn.com/coids-group3.jpg" alt="codis-group"></p>
<p>分配slot<br><img src="http://oh6ybr0jg.bkt.clouddn.com/codis-slot5.jpg" alt="codis-slot5"></p>
<p>启动codis-ha<br>nohup ./bin/codis-ha –log=ha.log –log-level=WARN –dashboard=127.0.0.1:18080 &amp;</p>
<p>[root@zhm1 codis]# ps -ef | grep codis<br>root       3096   2884  0 09:51 pts/0    00:00:32 bin/codis-dashboard –ncpu=2 –config=dashboard.conf –log=dashboard.log –log-level=WARN<br>root       3114   2884  0 09:52 pts/0    00:00:04 bin/codis-proxy –ncpu=2 –config=proxy.conf –log =proxy.log –log-level=WARN<br>root       3149   2884  0 09:53 pts/0    00:00:02 ./bin/codis-fe –ncpu=2 –log=fe.log –log-level=WARN –dashboard-list=conf/codis.json –listen=192.168.110.129:18090<br>root       3175      1  0 09:54 ?        00:00:08 ./bin/codis-server <em>:6379<br>root       3179      1  0 09:54 ?        00:00:08 ./bin/codis-server </em>:6380<br>root       3888      1  0 10:46 ?        00:00:02 ./bin/codis-server <em>:6382<br>root       3892      1  0 10:46 ?        00:00:02 ./bin/codis-server </em>:6381<br>root       4680   2884  0 11:12 pts/0    00:00:00 ./bin/codis-ha –log=ha.log –log-level=WARN –dashboard=127.0.0.1:18080<br>root       4712   2884  0 11:15 pts/0    00:00:00 grep –color=auto codis</p>
<p>kill6379 的端口<br>kill -9 3175<br>查看6380 的日志<br>3179:M 23 Dec 11:19:07.739 * MASTER MODE enabled (user request from ‘id=7 addr=192.168.110.129:51438 fd=8 name= age=0 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=slaveof’)<br>看到6380成为主</p>
<p><img src="http://oh6ybr0jg.bkt.clouddn.com/codis-group4.jpg" alt="codis-group4"></p>
<p>再启动6379 并没有成为6380的主，需要手动点击web上绿色的工具扳手<br>怀疑可能是我的配置文件没有写slave of的原因</p>
<p>再6380输入内容<br>[root@zhm1 codis]# ./bin/redis-cli  -p 6380<br>127.0.0.1:6380&gt; set aaa 123<br>OK<br>127.0.0.1:6380&gt; </p>
<p>启动6379看<br>[root@zhm1 codis]# ./bin/redis-cli  -p 6379<br>127.0.0.1:6379&gt; get aaa<br>“123”</p>
<p>总结codis和redis集群的区别</p>
<p>a. Redis Cluster 的集群信息存储在每个集群节点上，而Codis 集群的信息<br>存储在一个独立的存储系统（Zookeeper）里。<br>b. 外部访问集群：对Redis Cluster，直接通过以集群模式启动的redis 客户<br>端 “redis-cli -c”来访问。对 Codis 集群通过独立的 codis-proxy 节点来<br>访问。<br>c. Redis Cluster 有 16384 个slot 可以分配，而 Codis 集群只有1024 个<br>slot 可以分配。<br>d. 监控和操作：Codis 集群有图形化的 Code FE 管理工具（可以完成<br>Codis Proxy，Codis Group、Codis Server 的添加和删除，分配 Slot、<br>提升Slave 为Master 等操作），而 Redis Cluster 好像没有这类工具。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-tags " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/02/KafkaStream/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="张洪铭">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Hexo" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/02/KafkaStream/" itemprop="url">
                  Kafka Stream
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-02T23:33:30+08:00">
                2016-12-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/02/KafkaStream/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/02/KafkaStream/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>以下内容摘自官网，熟悉的同学可跳过</p>
<h2 id="Use-Kafka-Streams-to-process-data"><a href="#Use-Kafka-Streams-to-process-data" class="headerlink" title="Use Kafka Streams to process data"></a>Use Kafka Streams to process data</h2><p>Kafka Streams is a client library of Kafka for real-time stream processing and analyzing data stored in Kafka brokers. This quickstart example will demonstrate how to run a streaming application coded in this library. Here is the gist of the WordCountDemo example code (converted to use Java 8 lambda expressions for easy reading).<br>Kafka Streams是Kafka中用于客户端的库，主要用于获取实时流处理以及分析Kafka brokers中存储的数据。这个例子将会展示如何使用这个库来运行一个流式处理应用。这里有一个WordCountDemo的主要代码（转换成Java8 lambda表达式更易读）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">KTable wordCounts = textLines</div><div class="line">    <span class="comment">// Split each text line, by whitespace, into words.</span></div><div class="line">    .flatMapValues(value -&gt; Arrays.asList(value.toLowerCase().split(<span class="string">"\\W+"</span>)))</div><div class="line"></div><div class="line">    <span class="comment">// Ensure the words are available as record keys for the next aggregate operation.</span></div><div class="line">    .map((key, value) -&gt; <span class="keyword">new</span> KeyValue&lt;&gt;(value, value))</div><div class="line"></div><div class="line">    <span class="comment">// Count the occurrences of each word (record key) and store the results into a table named "Counts".</span></div><div class="line">    .countByKey(<span class="string">"Counts"</span>)</div></pre></td></tr></table></figure>
<p> It implements the WordCount algorithm, which computes a word occurrence histogram from the input text. However, unlike other WordCount examples you might have seen before that operate on bounded data, the WordCount demo application behaves slightly differently because it is designed to operate on an infinite, unbounded stream of data. Similar to the bounded variant, it is a stateful algorithm that tracks and updates the counts of words. However, since it must assume potentially unbounded input data, it will periodically output its current state and results while continuing to process more data because it cannot know when it has processed “all” the input data.</p>
<p>它实现了WordCount算法，计算了输入文本中的词频。然而，并不像其他的WordCount的例子，都是计算固定大小的数据，这个WordCount demo应用稍微有点不同，它是基于不会终止的数据流计算的。和计算固定数据的模型比较形似的是，它也会不停的更新词频计算结果。然而，由于它是基于永不停止的数据流，所以会周期性的输出当前的计算结果，他会不停的处理更多的数据，因为它也不知道何时它处理过“所有”的输入数据。</p>
<p>We will now prepare input data to a Kafka topic, which will subsequently be processed by a Kafka Streams application.<br>现在我们将输入数据导入Kafka topic，这些数据将会被Kafka Streams应用处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; echo -e <span class="string">"all streams lead to kafka\nhello kafka streams\njoin kafka summit"</span> &gt; file-input.txt</div></pre></td></tr></table></figure>
<p>Or on Windows:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; echo all streams lead to kafka&gt; file-input.txt</div><div class="line">&gt; echo hello kafka streams&gt;&gt; file-input.txt</div><div class="line">&gt; echo|set /p=join kafka summit&gt;&gt; file-input.txt</div></pre></td></tr></table></figure></p>
<p>Next, we send this input data to the input topic named streams-file-input using the console producer (in practice, stream data will likely be flowing continuously into Kafka where the application will be up and running):<br>接着，我们使用终端producer来将这些输入数据发送到名为streams-file-input的topic（在实践中，流数据会持续不断的流入kafka，当应用将会启动并运行时）：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; bin/kafka-topics.sh --create \</div><div class="line">            --zookeeper localhost:<span class="number">2181</span> \</div><div class="line">            --replication-factor <span class="number">1</span> \</div><div class="line">            --partitions <span class="number">1</span> \</div><div class="line">            --topic streams-file-input</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; bin/kafka-<span class="built_in">console</span>-producer.sh --broker-list localhost:<span class="number">9092</span> --topic streams-file-input &lt; file-input.txt</div></pre></td></tr></table></figure>
<p>We can now run the WordCount demo application to process the input data:<br>我们可以运行WordCount demo应用来处理输入数据<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; bin/kafka-run-<span class="class"><span class="keyword">class</span>.<span class="title">sh</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">kafka</span>.<span class="title">streams</span>.<span class="title">examples</span>.<span class="title">wordcount</span>.<span class="title">WordCountDemo</span></span></div></pre></td></tr></table></figure></p>
<p>There won’t be any STDOUT output except log entries as the results are continuously written back into another topic named streams-wordcount-output in Kafka. The demo will run for a few seconds and then, unlike typical stream processing applications, terminate automatically.<br>不会有任何的stdout输出除了日志条目，结果会持续不断的写回kafka中另一个名为streams-wordcount-output的topic。这个demo将会运行数秒，不会像典型的流处理应用，自动终止。</p>
<p>We can now inspect the output of the WordCount demo application by reading from its output topic:<br>我们现在通过阅读主题的数来来检查WordCount demo应用程序的输出： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; bin/kafka-<span class="built_in">console</span>-consumer.sh --bootstrap-server localhost:<span class="number">9092</span> \</div><div class="line">            --topic streams-wordcount-output \</div><div class="line">            --<span class="keyword">from</span>-beginning \</div><div class="line">            --formatter kafka.tools.DefaultMessageFormatter \</div><div class="line">            --property print.key=<span class="literal">true</span> \</div><div class="line">            --property print.value=<span class="literal">true</span> \</div><div class="line">            --property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer \</div><div class="line">            --property value.deserializer=org.apache.kafka.common.serialization.LongDeserializer</div></pre></td></tr></table></figure>
<p>with the following output data being printed to the console:<br>终端会打印出以下数据：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">all     <span class="number">1</span></div><div class="line">lead    <span class="number">1</span></div><div class="line">to      <span class="number">1</span></div><div class="line">hello   <span class="number">1</span></div><div class="line">streams <span class="number">2</span></div><div class="line">join    <span class="number">1</span></div><div class="line">kafka   <span class="number">3</span></div><div class="line">summit  <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>Here, the first column is the Kafka message key, and the second column is the message value, both in in java.lang.String format. Note that the output is actually a continuous stream of updates, where each data record (i.e. each line in the original output above) is an updated count of a single word, aka record key such as “kafka”. For multiple records with the same key, each later record is an update of the previous one.<br>第一列是Kafka消息的key，第二列是消息value，两者都是java.lang.String格式。注意，输出实际上应该是持续的更新数据流，数据流中的每一个记录（例如，上面输出的每一行）都是一个单独词汇的数量，或者是记录了key的数量，例如上面的“kafka”。对于多条记录的key一致这种情况，每一条后面的记录都是对前一条记录的更新。</p>
<p>Now you can write more input messages to the streams-file-input topic and observe additional messages added to streams-wordcount-output topic, reflecting updated word counts (e.g., using the console producer and the console consumer, as described above).<br>现在你可以写入更多的消息到streams-file-input这个topic，可以观察到更多的消息会发送到streams-wordcount-output这个topic，反映了更新之后的词汇数量。</p>
<p>You can stop the console consumer via Ctrl-C.<br>你可以使用Ctrl+C结束控制台的消费者</p>
<p>Stream Processing<br>Many users of Kafka process data in processing pipelines consisting of multiple stages, where raw input data is consumed from Kafka topics and then aggregated, enriched, or otherwise transformed into new topics for further consumption or follow-up processing. For example, a processing pipeline for recommending news articles might crawl article content from RSS feeds and publish it to an “articles” topic; further processing might normalize or deduplicate this content and published the cleansed article content to a new topic; a final processing stage might attempt to recommend this content to users. Such processing pipelines create graphs of real-time data flows based on the individual topics. Starting in 0.10.0.0, a light-weight but powerful stream processing library called Kafka Streams is available in Apache Kafka to perform such data processing as described above. Apart from Kafka Streams, alternative open source stream processing tools include Apache Storm and Apache Samza.<br>很多用户将kafka用作多级数据处理之间的消息管道：原始数据存放于Kafka不同的topics中，然后经过聚合、增强、或者其他的转换之后，导入Kafka新的topics中，以供后面的消费。例如，对于新闻推荐的处理流程来所：首先从RSS信息流中获取文章内容，然后导入名为“articles”的topic; 其次，后面的处理可能是对这些内容进行规范化或者精简操作，然后将经过上述处理的内容导入新的topic;最后的处理可能是试图将这些内容推荐给用户。这样的处理流程实际展现了实时流在独立的topics之间流动的流程图。从0.10.0.0开始，Apache Kafka推出了一款称为Kafka Streams的流式处理库，优点是轻量级同时性能很好，它可以完成上面所描述的多级处理。除了Kafka streams之外，还有一些开源流式处理工具可以选用，包括Apache  Storm和Samza。</p>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Kafka Streams is a client library for processing and analyzing data stored in Kafka and either write the resulting data back to Kafka or send the final output to an external system. It builds upon important stream processing concepts such as properly distinguishing between event time and processing time, windowing support, and simple yet efficient management of application state. Kafka Streams has a low barrier to entry: You can quickly write and run a small-scale proof-of-concept on a single machine; and you only need to run additional instances of your application on multiple machines to scale up to high-volume production workloads. Kafka Streams transparently handles the load balancing of multiple instances of the same application by leveraging Kafka’s parallelism model.<br>Kafka Streams是一个客户端程序库用于处理和分析存储在Kafka中的数据，并将得到的数据写入Kafka或发送最终输出到外部系统。它建立在如适当区分事件的时间和加工时间，窗口函数的支持，和简单而高效的应用程序状态管理。Kafka Streams有一个低门槛进入：你可以快速编写和运行一个小规模的概念证明在一台机器上，你只需要运行在多台机器上的应用程序的额外的实例扩展到高容量的生产工作负载。Kafka Streams 透明地处理相同的应用程序通过利用Kafka 的并行模型的多个实例的负载平衡。</p>
<p>Some highlights of Kafka Streams:<br>Kafka Streams的一些亮点</p>
<ul>
<li>Designed as a simple and lightweight client library, which can be<br>easily embedded in any Java application and integrated with any<br>existing packaging, deployment and operational tools that users have<br>for their streaming applications.</li>
<li>作为一个简单而轻量级的客户端库，它可以方便的嵌入任何java应用和集成任何现有的包，部署和运营工具，用户有对于他们的流应用。</li>
<li>Has no external dependencies on systems other than Apache Kafka<br>itself as the internal messaging layer; notably, it uses Kafka’s<br>partitioning model to horizontally scale processing while maintaining<br>strong ordering guarantees.</li>
<li>对其他比Apache Kafka 没有外部依赖它本身作为内部消息层，特别是，它使用Kafka的 分割模型在保持同时进行水平缩放处理的分区模型强排序保证。</li>
<li>Supports fault-tolerant local state, which enables very fast and<br>efficient stateful operations like joins and windowed aggregations.</li>
<li>支持容错的本地状态，使非常快速和高效的状态操作的加入和窗口聚集。</li>
<li>Employs one-record-at-a-time processing to achieve low processing<br>latency, and supports event-time based windowing operations.</li>
<li>采用同一时刻只有一条记录处理实现低的处理延迟，并支持基于时间事件的窗口操作。</li>
<li>Offers necessary stream processing primitives, along with a<br>high-level Streams DSL and a low-level Processor API.</li>
<li>提供必要的流处理基元，以及 high-level Streams DSL和 low-level Processor API。</li>
</ul>
<h3 id="Developer-Guide-开发者指南"><a href="#Developer-Guide-开发者指南" class="headerlink" title="Developer Guide 开发者指南"></a>Developer Guide 开发者指南</h3><p>There is a quickstart example that provides how to run a stream processing program coded in the Kafka Streams library. This section focuses on how to write, configure, and execute a Kafka Streams application.</p>
<p>有一个快速入门示例提供了如何运行一个流处理程序在卡夫卡流的库代码。本节重点介绍如何编写、配置和执行卡夫卡流应用程序。</p>
<h3 id="Core-Concepts-核心概念"><a href="#Core-Concepts-核心概念" class="headerlink" title="Core Concepts 核心概念"></a>Core Concepts 核心概念</h3><p>We first summarize the key concepts of Kafka Streams.<br>我们首先总结了Kafka Streams的关键概念。</p>
<h3 id="Stream-Processing-Topology-流处理Topology"><a href="#Stream-Processing-Topology-流处理Topology" class="headerlink" title="Stream Processing Topology 流处理Topology"></a>Stream Processing Topology 流处理Topology</h3><ul>
<li>A stream is the most important abstraction provided by Kafka Streams:<br>it represents an unbounded, continuously updating data set. A stream<br>is an ordered, replayable, and fault-tolerant sequence of immutable<br>data records, where a data record is defined as a key-value pair.</li>
<li>流是Kafka Streams提供的最重要的抽象：它表示一个无界的，不断更新的数据集。一个流是一个有序的、可重复的，和不变的容错序列数据记录，其中一个数据记录被定义为一个键值对。</li>
<li>A stream processing application written in Kafka Streams defines its<br>computational logic through one or more processor topologies, where a<br>processor topology is a graph of stream processors (nodes) that are<br>connected by streams (edges).<br>在Kafka Streams中写的流处理应用程序定义了它的计算逻辑通过一个或多个处理器的topologies，其中处理器的topology是一个流处理器（节点）的图形由流连接（边缘）。</li>
<li>A stream processor is a node in the processor topology; it represents<br>a processing step to transform data in streams by receiving one input<br>record at a time from its upstream processors in the topology,<br>applying its operation to it, and may subsequently producing one or<br>more output records to its downstream processors.</li>
<li>流处理器是处理器topology中的一个节点；它表示通过接收一个输入来变换流中的数据的处理步骤在topology中的上游处理器上记录的时间，应用它的操作，并可能随后产生一个或向下游处理器的更多输出记录。</li>
</ul>
<p>Kafka Streams offers two ways to define the stream processing topology: the Kafka Streams DSL provides the most common data transformation operations such as map and filter; the lower-level Processor API allows developers define and connect custom processors as well as to interact with state stores.<br>Kafka Streams 提供了两种方式来定义流处理topology：Kafka Streams DSL提供了最常用的数据转换操作，如map和filter；lower-level Processor API允许开发者定义和连接定制处理器以及存储交互的状态。</p>
<h3 id="Time-时间"><a href="#Time-时间" class="headerlink" title="Time 时间"></a>Time 时间</h3><p>A critical aspect in stream processing is the notion of time, and how it is modeled and integrated. For example, some operations such as windowing are defined based on time boundaries.<br>流处理中的一个关键方面是时间的概念，以及它是如何建模和集成。例如，一些操作如窗口是基于时间边界的定义。</p>
<p>Common notions of time in streams are:<br>流中的时间的共同概念是： </p>
<ul>
<li>Event time - The point in time when an event or data record occurred,<br>i.e. was originally created “at the source”.</li>
<li>事件时间 - 当发生事件或数据记录时的时间点，即最初创建的“在源头上”。</li>
<li>Processing time - The point in time when the event or data record<br>happens to be processed by the stream processing application, i.e.<br>when the record is being consumed. The processing time may be<br>milliseconds, hours, or days etc. later than the original event time.</li>
<li>处理时间 - 事件或数据记录的时间点碰巧被流处理应用程序处理，即当记录被消耗。处理时间可能是比原始事件时间晚的毫秒数、小时或数天等。</li>
<li>Ingestion time - The point in time when an event or data record is<br>stored in a topic partition by a Kafka broker. The difference to<br>event time is that this ingestion timestamp is generated when the<br>record is appended to the target topic by the Kafka broker, not when<br>the record is created “at the source”. The difference to processing<br>time is that processing time is when the stream processing<br>application processes the record. For example, if a record is never<br>processed, there is no notion of processing time for it, but it still<br>has an ingestion time.</li>
<li>摄取时间 - 当一个事件或数据记录的时间点存储在Kafka broker的主题分区中。<br>事件时间不同的是，这种摄取时间戳时产生的记录追加到目标主题由Kafka broker ，而不是当记录是在“源”创建的。处理差异时间是处理时间的时候是流处理的应用程序处理记录。例如，如果一个记录是从来没有处理，没有处理时间的概念，但它仍然有一个摄取时间</li>
</ul>
<p>The choice between event-time and ingestion-time is actually done through the configuration of Kafka (not Kafka Streams): From Kafka 0.10.x onwards, timestamps are automatically embedded into Kafka messages. Depending on Kafka’s configuration these timestamps represent event-time or ingestion-time. The respective Kafka configuration setting can be specified on the broker level or per topic. The default timestamp extractor in Kafka Streams will retrieve these embedded timestamps as-is. Hence, the effective time semantics of your application depend on the effective Kafka configuration for these embedded timestamps.<br>事件的时间和摄取时间之间的选择实际上是通过Kafka的配置（不是Kafka Streams）：从Kafka0.10.x起，时间戳被自动嵌入到Kafka的消息中。根据Kafka的配置这些时间戳表示事件时间或摄取时间。各自的Kafka配置设置可以在broker级别或每个主题上指定。在Kafka Streams的默认时间戳提取器将检索这些嵌入时间戳as-is。因此，您的应用程序的有效时间语义依赖于有效的Kafka配置这些嵌入时间戳。</p>
<p>Kafka Streams assigns a timestamp to every data record via the TimestampExtractor interface. Concrete implementations of this interface may retrieve or compute timestamps based on the actual contents of data records such as an embedded timestamp field to provide event-time semantics, or use any other approach such as returning the current wall-clock time at the time of processing, thereby yielding processing-time semantics to stream processing applications. Developers can thus enforce different notions of time depending on their business needs. For example, per-record timestamps describe the progress of a stream with regards to time (although records may be out-of-order within the stream) and are leveraged by time-dependent operations such as joins.<br>Kafka Streams分配一个时间戳的每一个数据记录通过TimestampExtractor接口。这个接口的具体实现可以检索或计算基于数据记录如嵌入时间戳字段提供事件时间语义内容的时间戳，或使用任何其他的方法，如加工时返回当前时钟时间，从而产生语义流处理应用程序的处理时间。因此，开发人员可以执行不同的时间概念，这取决于他们的业务需求。例如，每个记录时间戳的描述关于流时间的进展（虽然记录可能会超出流）和促使时间依赖操作例如 joins。</p>
<p>Finally, whenever a Kafka Streams application writes records to Kafka, then it will also assign timestamps to these new records. The way the timestamps are assigned depends on the context:<br>最后，当Kafka记录写入到Kafka Streams应用，那么它也会对新纪录指定时间戳。时间戳是分配方式取决于context： </p>
<ul>
<li>When new output records are generated via processing some input<br>record, for example, context.forward() triggered in the process()<br>function call, output record timestamps are inherited from input<br>record timestamps directly.</li>
<li>当通过处理一些输入而产生新的输出记录时记录，例如，context.forward()引发的process()函数调用，输出记录的时间戳是继承自输入直接记录时间戳。</li>
<li>When new output records are generated via periodic functions such as<br>punctuate(), the output record timestamp is defined as the current<br>internal time (obtained through context.timestamp()) of the stream<br>task.</li>
<li>当新的输出记录通过诸如punctuate()周期函数生成的输出记录时间戳定义为当前的内部时间（context.timestamp()获得）的流任务。</li>
<li>For aggregations, the timestamp of a resulting aggregate update<br>record will be that of the latest arrived input record that triggered<br>the update.</li>
<li>对于一个聚合，形成的聚合更新记录的时间戳将最新到达的输入记录触发更新。</li>
</ul>
<h3 id="States-状态"><a href="#States-状态" class="headerlink" title="States 状态"></a>States 状态</h3><p>Some stream processing applications don’t require state, which means the processing of a message is independent from the processing of all other messages. However, being able to maintain state opens up many possibilities for sophisticated stream processing applications: you can join input streams, or group and aggregate data records. Many such stateful operators are provided by the Kafka Streams DSL.<br>一些流处理应用程序不需要状态，这意味着消息的处理是独立于所有其他消息的处理。然而，能够保持状态为复杂的流处理应用程序打开了许多可能性：您可以加入输入流，或组和汇总数据记录。许多这样的状态的操作，由Kafka Streams DSL提供。</p>
<p>Kafka Streams provides so-called state stores, which can be used by stream processing applications to store and query data. This is an important capability when implementing stateful operations. Every task in Kafka Streams embeds one or more state stores that can be accessed via APIs to store and query data required for processing. These state stores can either be a persistent key-value store, an in-memory hashmap, or another convenient data structure. Kafka Streams offers fault-tolerance and automatic recovery for local state stores.<br>Kafka Streams提供了所谓的状态存储，它可以用于流处理应用程序来存储和查询数据。当实施状态操作时这是一个重要的能力。在Kafka Streams的每一项任务的一个或多个状态存储将可以通过API来存储和查询处理所需的数据访问。这些状态存储可以是一个持续的键值存储，内存中的HashMap，或另一个方便的数据结构。Kafka Streams提供了容错和本地状态存储的自动恢复。</p>
<p>Kafka Streams allows direct read-only queries of the state stores by methods, threads, processes or applications external to the stream processing application that created the state stores. This is provided through a feature called Interactive Queries. All stores are named and Interactive Queries exposes only the read operations of the underlying implementation.<br>Kafka Streams允许通过方法，线程，进程或应用程序的外部的流处理应用程序创建的状态存储的状态存储的直接只读查询。这是通过一个被称为交互式查询的功能。所有的存储都被命名和交互查询只公开底层实现的读操作。</p>
<p>As we have mentioned above, the computational logic of a Kafka Streams application is defined as a processor topology. Currently Kafka Streams provides two sets of APIs to define the processor topology, which will be described in the subsequent sections.<br>正如我们上文所提到的，Kafka Streams应用程序的计算逻辑被定义为一个处理topology。目前，Kafka Streams提供了两组的接口来定义处理的topology，这将在随后的章节中描述。 </p>
<h2 id="Low-Level-Processor-API"><a href="#Low-Level-Processor-API" class="headerlink" title="Low-Level Processor API"></a>Low-Level Processor API</h2><h3 id="Processor"><a href="#Processor" class="headerlink" title="Processor"></a>Processor</h3><p>Developers can define their customized processing logic by implementing the Processor interface, which provides process and punctuate methods. The process method is performed on each of the received record; and the punctuate method is performed periodically based on elapsed time. In addition, the processor can maintain the current ProcessorContext instance variable initialized in the init method, and use the context to schedule the punctuation period (context().schedule), to forward the modified / new key-value pair to downstream processors (context().forward), to commit the current processing progress (context().commit), etc.<br>开发者可以通过处理器接口定义自己的定制的处理逻辑，它提供了方法和标点的方法。process方法是对每个接收的记录执行；和标点法是基于时间进行定期。此外，该处理器可以维持目前的ProcessorContext实例变量在init方法初始化，并使用context安排标点符号周期（context().schedule），提出修改/新的键值对下游处理器（context().forward），把当前的处理进度（context().commit），等。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyProcessor</span> <span class="keyword">extends</span> <span class="title">Processor</span> </span>&#123;</div><div class="line">        private ProcessorContext context;</div><div class="line">        private KeyValueStore kvStore;</div><div class="line">        @Override</div><div class="line">        @SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line">        public <span class="keyword">void</span> init(ProcessorContext context) &#123;</div><div class="line">            <span class="keyword">this</span>.context = context;</div><div class="line">            <span class="keyword">this</span>.context.schedule(<span class="number">1000</span>);</div><div class="line">            <span class="keyword">this</span>.kvStore = (KeyValueStore) context.getStateStore(<span class="string">"Counts"</span>);</div><div class="line">        &#125;</div><div class="line">        @Override</div><div class="line">        public <span class="keyword">void</span> process(<span class="built_in">String</span> dummy, <span class="built_in">String</span> line) &#123;</div><div class="line">            <span class="built_in">String</span>[] words = line.toLowerCase().split(<span class="string">" "</span>);</div><div class="line">            <span class="keyword">for</span> (<span class="built_in">String</span> word : words) &#123;</div><div class="line">                Integer oldValue = <span class="keyword">this</span>.kvStore.get(word);</div><div class="line">                <span class="keyword">if</span> (oldValue == <span class="literal">null</span>) &#123;</div><div class="line">                    <span class="keyword">this</span>.kvStore.put(word, <span class="number">1</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">this</span>.kvStore.put(word, oldValue + <span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        @Override</div><div class="line">        public <span class="keyword">void</span> punctuate(long timestamp) &#123;</div><div class="line">            KeyValueIterator iter = <span class="keyword">this</span>.kvStore.all();</div><div class="line"></div><div class="line">            <span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line">                KeyValue entry = iter.next();</div><div class="line">                context.forward(entry.key, entry.value.toString());</div><div class="line">            &#125;</div><div class="line">            iter.close();</div><div class="line">            context.commit();</div><div class="line">        &#125;</div><div class="line">        @Override</div><div class="line">        public <span class="keyword">void</span> close() &#123;</div><div class="line">            <span class="keyword">this</span>.kvStore.close();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>In the above implementation, the following actions are performed:<br>在上面的实现中，执行以下操作：</p>
<ul>
<li>In the init method, schedule the punctuation every 1 second and<br>retrieve the local state store by its name “Counts”.</li>
<li>在init方法，schedule每1秒和标点符号检索本地状态存储由它的名称“计数”。</li>
<li>In the process method, upon each received record, split the value<br>string into words, and update their counts into the state store (we<br>will talk about this feature later in the section).</li>
<li>在处理方法中，在每个接收到的记录中，将值字符串分割成单词，并更新他们的计数到状态存储区（我们将在本节中讨论这个功能）。</li>
<li>In the punctuate method, iterate the local state store and send the<br>aggregated counts to the downstream processor, and commit the current<br>stream state.</li>
<li>在标点法，迭代局部状态存储和发送汇总计数到下游的处理器，并承诺目前流状态。</li>
</ul>
<h3 id="Processor-Topology"><a href="#Processor-Topology" class="headerlink" title="Processor Topology"></a>Processor Topology</h3><p>With the customized processors defined in the Processor API, developers can use the TopologyBuilder to build a processor topology by connecting these processors together:<br>与定制的处理器在Processor API，开发者可以使用TopologyBuilder来连接这些处理器一起建立一个topology：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">builder.addSource(<span class="string">"SOURCE"</span>, <span class="string">"src-topic"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS1"</span>, <span class="attr">MyProcessor1</span>::<span class="keyword">new</span> <span class="comment">/* the ProcessorSupplier that can generate MyProcessor1 */</span>, <span class="string">"SOURCE"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS2"</span>, <span class="attr">MyProcessor2</span>::<span class="keyword">new</span> <span class="comment">/* the ProcessorSupplier that can generate MyProcessor2 */</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS3"</span>, <span class="attr">MyProcessor3</span>::<span class="keyword">new</span> <span class="comment">/* the ProcessorSupplier that can generate MyProcessor3 */</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        .addSink(<span class="string">"SINK1"</span>, <span class="string">"sink-topic1"</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        .addSink(<span class="string">"SINK2"</span>, <span class="string">"sink-topic2"</span>, <span class="string">"PROCESS2"</span>)</div><div class="line">        .addSink(<span class="string">"SINK3"</span>, <span class="string">"sink-topic3"</span>, <span class="string">"PROCESS3"</span>);</div></pre></td></tr></table></figure></p>
<p>There are several steps in the above code to build the topology, and here is a quick walk through:<br>在上面的代码中有几个步骤来构建topology，这里是一个快速的步行通过：</p>
<ul>
<li>First of all a source node named “SOURCE” is added to the topology<br>using the addSource method, with one Kafka topic “src-topic” fed to<br>it.</li>
<li>首先，源节点命名为“源”添加到topology使用addSource方法，使用“src-topic”这个Kafka 主题。</li>
<li>Three processor nodes are then added using the addProcessor method;<br>here the first processor is a child of the “SOURCE” node, but is the<br>parent of the other two processors.</li>
<li>三个processor节点，然后使用addProcessor方法添加；这里第一个processor是一个“源”节点的子节点，但是其他两处processors</li>
<li>Finally three sink nodes are added to complete the topology using the<br>addSink method, each piping from a different parent processor node<br>and writing to a separate topic.</li>
<li>最后，添加三个汇聚节点来完成使用的topology addSink方法，每个管道从不同的父节点的processor和写到一个单独的主题。</li>
</ul>
<h3 id="Local-State-Store本地状态存储"><a href="#Local-State-Store本地状态存储" class="headerlink" title="Local State Store本地状态存储"></a>Local State Store本地状态存储</h3><p>Note that the Processor API is not limited to only accessing the current records as they arrive, but can also maintain local state stores that keep recently arrived records to use in stateful processing operations such as aggregation or windowed joins. To take advantage of this local states, developers can use the TopologyBuilder.addStateStore method when building the processor topology to create the local state and associate it with the processor nodes that needs to access it; or they can connect a created local state store with the existing processor nodes through TopologyBuilder.connectProcessorAndStateStores.<br>注意Processor API不仅限于访问当前记录，还可以维持本地状态村粗，使记录使用状态的处理操作，如聚集或窗口的加入。利用局部状态，开发人员可以使用TopologyBuilder.addStateStore方法当搭建processor topology创建本地状态，它与processor节点需要访问它的联想；或者他们可以连接创建的局部状态存储与现有的处理器节点通过TopologyBuilder.connectProcessorAndStateStores.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">    builder.addSource(<span class="string">"SOURCE"</span>, <span class="string">"src-topic"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS1"</span>, <span class="attr">MyProcessor1</span>::<span class="keyword">new</span>, <span class="string">"SOURCE"</span>)</div><div class="line">        <span class="comment">// create the in-memory state store "COUNTS" associated with processor "PROCESS1"</span></div><div class="line">        .addStateStore(Stores.create(<span class="string">"COUNTS"</span>).withStringKeys().withStringValues().inMemory().build(), <span class="string">"PROCESS1"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS2"</span>, <span class="attr">MyProcessor3</span>::<span class="keyword">new</span> <span class="comment">/* the ProcessorSupplier that can generate MyProcessor3 */</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        .addProcessor(<span class="string">"PROCESS3"</span>, <span class="attr">MyProcessor3</span>::<span class="keyword">new</span> <span class="comment">/* the ProcessorSupplier that can generate MyProcessor3 */</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        <span class="comment">// connect the state store "COUNTS" with processor "PROCESS2"</span></div><div class="line">        .connectProcessorAndStateStores(<span class="string">"PROCESS2"</span>, <span class="string">"COUNTS"</span>);</div><div class="line">        .addSink(<span class="string">"SINK1"</span>, <span class="string">"sink-topic1"</span>, <span class="string">"PROCESS1"</span>)</div><div class="line">        .addSink(<span class="string">"SINK2"</span>, <span class="string">"sink-topic2"</span>, <span class="string">"PROCESS2"</span>)</div><div class="line">        .addSink(<span class="string">"SINK3"</span>, <span class="string">"sink-topic3"</span>, <span class="string">"PROCESS3"</span>);</div></pre></td></tr></table></figure></p>
<p>例子：<br>搭建kafka_2.11-0.10.1.0 集群：<br>设置server.properties<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">#broker的全局唯一编号，不能重复</div><div class="line">broker.id=0</div><div class="line"></div><div class="line">#用来监听链接的端口，producer或consumer将在此端口建立连接</div><div class="line">port=9092</div><div class="line"></div><div class="line">#处理网络请求的线程数量</div><div class="line">num.network.threads=3</div><div class="line"></div><div class="line">#用来处理磁盘IO的线程数量</div><div class="line">num.io.threads=8</div><div class="line"></div><div class="line">#发送套接字的缓冲区大小</div><div class="line">socket.send.buffer.bytes=102400</div><div class="line"></div><div class="line">#接受套接字的缓冲区大小</div><div class="line">socket.receive.buffer.bytes=102400</div><div class="line"></div><div class="line">#请求套接字的缓冲区大小</div><div class="line">socket.request.max.bytes=104857600</div><div class="line"></div><div class="line">#kafka运行日志存放的路径</div><div class="line">log.dirs=/home/hadoop/apps/kafka_2.11-0.10.1.0/logs/kafka</div><div class="line"></div><div class="line">#topic在当前broker上的分片个数</div><div class="line">num.partitions=2</div><div class="line"></div><div class="line">#用来恢复和清理data下数据的线程数量</div><div class="line">num.recovery.threads.per.data.dir=1</div><div class="line"></div><div class="line">#segment文件保留的最长时间，超时将被删除</div><div class="line">log.retention.hours=168</div><div class="line"></div><div class="line">#滚动生成新的segment文件的最大时间</div><div class="line">log.roll.hours=168</div><div class="line"></div><div class="line">#日志文件中每个segment的大小，默认为1G</div><div class="line">log.segment.bytes=1073741824</div><div class="line"></div><div class="line">#周期性检查文件大小的时间</div><div class="line">log.retention.check.interval.ms=300000</div><div class="line"></div><div class="line">#日志清理是否打开</div><div class="line">log.cleaner.enable=true</div><div class="line"></div><div class="line">#broker需要使用zookeeper保存meta数据</div><div class="line">zookeeper.connect=www.hadoop01.com:2181,www.hadoop02.com:2181,www.hadoop03.com:2181/kafka0.10.1.0</div><div class="line"></div><div class="line">#zookeeper链接超时时间</div><div class="line">zookeeper.connection.timeout.ms=6000</div><div class="line"></div><div class="line">#partion buffer中，消息的条数达到阈值，将触发flush到磁盘</div><div class="line">log.flush.interval.messages=10000</div><div class="line"></div><div class="line">#消息buffer的时间，达到阈值，将触发flush到磁盘</div><div class="line">log.flush.interval.ms=3000</div><div class="line"></div><div class="line">#删除topic需要server.properties中设置delete.topic.enable=true否则只是标记删除</div><div class="line">delete.topic.enable=true</div><div class="line"></div><div class="line">#此处的host.name为本机IP(重要),如果不改,则客户端会抛出:Producer connection to localhost:9092 unsuccessful 错误!</div><div class="line">host.name=www.hadoop01.com</div></pre></td></tr></table></figure></p>
<p>分发到其他机器<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scp -rp kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.0</span>/ hadoop@www.hadoop02.com:<span class="regexp">/home/</span>hadoop/apps/</div><div class="line">scp -rp kafka_2<span class="number">.11</span><span class="number">-0.10</span><span class="number">.1</span><span class="number">.0</span>/ hadoop@www.hadoop03.com:<span class="regexp">/home/</span>hadoop/apps/</div></pre></td></tr></table></figure></p>
<p>修改server.properties 以下两个参数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">broker.id=<span class="number">0</span></div><div class="line">host.name=www.hadoop01.com</div></pre></td></tr></table></figure></p>
<p>zookeeper设置，启动略。</p>
<p>创建主题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[hadoop@www.hadoop02.com bin]$./kafka-topics.sh --create --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic words</div><div class="line">Created topic <span class="string">"words"</span>.</div><div class="line">[hadoop@www.hadoop02.com bin]$./kafka-topics.sh --create --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --replication-factor <span class="number">1</span> --partitions <span class="number">1</span> --topic counts</div><div class="line">Created topic <span class="string">"counts"</span>.</div><div class="line">[hadoop@www.hadoop02.com bin]$./kafka-topics.sh  --describe --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --topic words</div><div class="line">        Topic:words     PartitionCount:<span class="number">1</span>        ReplicationFactor:<span class="number">1</span>     Configs:</div><div class="line">        Topic: words    Partition: <span class="number">0</span>    Leader: <span class="number">2</span>       Replicas: <span class="number">2</span>     Isr: <span class="number">2</span></div><div class="line">[hadoop@www.hadoop02.com bin]$./kafka-topics.sh  --describe --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --topic counts</div><div class="line">        Topic:counts    PartitionCount:<span class="number">1</span>        ReplicationFactor:<span class="number">1</span>     Configs:</div><div class="line">        Topic: counts   Partition: <span class="number">0</span>    Leader: <span class="number">2</span>       Replicas: <span class="number">2</span>     Isr: <span class="number">2</span></div></pre></td></tr></table></figure>
<p>依次启动：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicLong;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.DoubleDeserializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.IntegerDeserializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DemoConsumerManualCommit</span> </span>&#123;</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws Exception &#123;</div><div class="line">		args = <span class="keyword">new</span> <span class="built_in">String</span>[] &#123; <span class="string">"www.hadoop01.com:9092"</span>, <span class="string">"gender-amount"</span>, <span class="string">"group4"</span>, <span class="string">"consumer2"</span> &#125;;</div><div class="line">		<span class="keyword">if</span> (args == <span class="literal">null</span> || args.length != <span class="number">4</span>) &#123;</div><div class="line">			System.err.println(</div><div class="line">					<span class="string">"Usage:\n\tjava -jar kafka_consumer.jar $&#123;bootstrap_server&#125; $&#123;topic_name&#125; $&#123;group_name&#125; $&#123;client_id&#125;"</span>);</div><div class="line">			System.exit(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">String</span> bootstrap = args[<span class="number">0</span>];</div><div class="line">		<span class="built_in">String</span> topic = args[<span class="number">1</span>];</div><div class="line">		<span class="built_in">String</span> groupid = args[<span class="number">2</span>];</div><div class="line">		<span class="built_in">String</span> clientid = args[<span class="number">3</span>];</div><div class="line">		</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">		props.put(<span class="string">"bootstrap.servers"</span>, bootstrap);</div><div class="line">		props.put(<span class="string">"group.id"</span>, groupid);</div><div class="line">		props.put(<span class="string">"enable.auto.commit"</span>, <span class="string">"false"</span>);</div><div class="line">		props.put(<span class="string">"key.deserializer"</span>, StringDeserializer.class.getName());</div><div class="line">		<span class="comment">//props.put("value.deserializer", DoubleDeserializer.class.getName());</span></div><div class="line">		props.put(<span class="string">"value.deserializer"</span>, IntegerDeserializer.class.getName());</div><div class="line">		props.put(<span class="string">"max.poll.interval.ms"</span>, <span class="string">"300000"</span>);</div><div class="line">		props.put(<span class="string">"max.poll.records"</span>, <span class="string">"500"</span>);</div><div class="line">		props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"earliest"</span>);</div><div class="line">		KafkaConsumer&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</div><div class="line">		consumer.subscribe(Arrays.asList(topic));</div><div class="line">		AtomicLong atomicLong = <span class="keyword">new</span> AtomicLong();</div><div class="line">		<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">			ConsumerRecords&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; records = consumer.poll(<span class="number">100</span>);</div><div class="line">			records.forEach(record -&gt; &#123;</div><div class="line">				System.out.printf(<span class="string">"client : %s , topic: %s , partition: %d , offset = %d, key = %s, value = %s%n"</span>,</div><div class="line">						clientid, record.topic(), record.partition(), record.offset(), record.key(), record.value());</div><div class="line">				<span class="keyword">if</span> (atomicLong.get() % <span class="number">10</span> == <span class="number">0</span>) &#123;</div><div class="line"><span class="comment">//					consumer.commitSync();</span></div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.Properties;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.IntegerSerializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.Serdes;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringDeserializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.StringSerializer;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.KafkaStreams;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.StreamsConfig;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.processor.TopologyBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.kafka.streams.state.Stores;</div><div class="line"></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">WordCountTopology</span> </span>&#123;</div><div class="line"></div><div class="line">	public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) throws IOException &#123;</div><div class="line">		Properties props = <span class="keyword">new</span> Properties();</div><div class="line">        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="string">"streams-wordcount-processor"</span>);</div><div class="line">        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"www.hadoop01.com:9092"</span>);</div><div class="line">        props.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, <span class="string">"www.hadoop01.com:2181/kafka0.10.1.0"</span>);</div><div class="line">        props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</div><div class="line">        props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, Serdes.Integer().getClass());</div><div class="line">        props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, <span class="string">"earliest"</span>);</div><div class="line">		</div><div class="line">		TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		builder.addSource(<span class="string">"SOURCE"</span>, <span class="keyword">new</span> StringDeserializer(), <span class="keyword">new</span> StringDeserializer(), <span class="string">"words"</span>)</div><div class="line">				.addProcessor(<span class="string">"WordCountProcessor"</span>, <span class="attr">WordCountProcessor</span>::<span class="keyword">new</span>, <span class="string">"SOURCE"</span>)</div><div class="line">				.addStateStore(Stores.create(<span class="string">"Counts"</span>).withStringKeys().withIntegerValues().inMemory().build(), <span class="string">"WordCountProcessor"</span>)</div><div class="line"><span class="comment">//				.connectProcessorAndStateStores("WordCountProcessor", "Counts")</span></div><div class="line">				.addSink(<span class="string">"SINK"</span>, <span class="string">"count"</span>, <span class="keyword">new</span> StringSerializer(), <span class="keyword">new</span> IntegerSerializer(), <span class="string">"WordCountProcessor"</span>);</div><div class="line">		</div><div class="line">        KafkaStreams stream = <span class="keyword">new</span> KafkaStreams(builder, props);</div><div class="line">        stream.start();</div><div class="line">        System.in.read();</div><div class="line">        stream.close();</div><div class="line">        stream.cleanUp();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动producer<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kafka-<span class="built_in">console</span>-producer.sh --broker-list www.hadoop01.com:<span class="number">9092</span> --topic words</div><div class="line">hello apache hello kafka</div></pre></td></tr></table></figure></p>
<p>报错：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Exception <span class="keyword">in</span> thread <span class="string">"StreamThread-1"</span> org.apache.kafka.streams.errors.StreamsException: Extracted timestamp value is negative, which is not allowed.</div><div class="line">	at org.apache.kafka.streams.processor.internals.RecordQueue.addRawRecords(RecordQueue.java:<span class="number">111</span>)</div><div class="line">	at org.apache.kafka.streams.processor.internals.PartitionGroup.addRawRecords(PartitionGroup.java:<span class="number">117</span>)</div><div class="line">	at org.apache.kafka.streams.processor.internals.StreamTask.addRecords(StreamTask.java:<span class="number">144</span>)</div><div class="line">	at org.apache.kafka.streams.processor.internals.StreamThread.runLoop(StreamThread.java:<span class="number">415</span>)</div><div class="line">	at org.apache.kafka.streams.processor.internals.StreamThread.run(StreamThread.java:<span class="number">242</span>)</div></pre></td></tr></table></figure></p>
<p>为时间戳的原因<br>kafka 18May的时候何如了时间戳的东东<br><img src="http://oh6ybr0jg.bkt.clouddn.com/kafka-stream%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%B3.png" alt="image"><br>后来更改了主题：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">bin/kafka-topics.sh --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --create --topic word --partitions <span class="number">1</span> --replication-factor <span class="number">1</span> --config message.timestamp.type=LogAppendTime</div><div class="line">bin/kafka-topics.sh --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span> --create --topic count --partitions <span class="number">1</span> --replication-factor <span class="number">1</span> --config message.timestamp.type=LogAppendTime</div></pre></td></tr></table></figure></p>
<p>先启动DemoConsumerManualCommit再启动WordCountTopology</p>
<p>命令行输入<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kafka-<span class="built_in">console</span>-producer.sh --broker-list www.hadoop01.com:<span class="number">9092</span> --topic word_test</div><div class="line">hello apache kafka hello apache spark hello storm</div></pre></td></tr></table></figure></p>
<p>最后控制台输出</p>
<p>应该是<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">client : consumer2 , <span class="attr">topic</span>: count , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">0</span>, key = apache, value = <span class="number">2</span></div><div class="line">client : consumer2 , <span class="attr">topic</span>: count , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">1</span>, key = hello, value = <span class="number">3</span></div><div class="line">client : consumer2 , <span class="attr">topic</span>: count , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">2</span>, key = kafka, value = <span class="number">1</span></div><div class="line">client : consumer2 , <span class="attr">topic</span>: count , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">3</span>, key = spark, value = <span class="number">1</span></div><div class="line">client : consumer2 , <span class="attr">topic</span>: count , <span class="attr">partition</span>: <span class="number">0</span> , offset = <span class="number">4</span>, key = storm, value = <span class="number">1</span></div></pre></td></tr></table></figure></p>
<p>查看所有主题<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bin/kafka-topics.sh --list --zookeeper www.hadoop01.com:<span class="number">2181</span>/kafka0<span class="number">.10</span><span class="number">.1</span><span class="number">.0</span></div></pre></td></tr></table></figure></p>
<p>发现多了一个<br>streams-wordcount-processor-Counts-changelog</p>
<p>In the next section we present another way to build the processor topology: the Kafka Streams DSL. </p>
<h2 id="High-Level-Streams-DSL"><a href="#High-Level-Streams-DSL" class="headerlink" title="High-Level Streams DSL"></a>High-Level Streams DSL</h2><p>To build a processor topology using the Streams DSL, developers can apply the KStreamBuilder class, which is extended from the TopologyBuilder. A simple example is included with the source code for Kafka in the streams/examples package. The rest of this section will walk through some code to demonstrate the key steps in creating a topology using the Streams DSL, but we recommend developers to read the full example source codes for details.<br>使用DSL Streams创建topology，开发人员可以应用KStreamBuilder类，这是从TopologyBuilder延伸。一个简单的例子是包含了streams/examples package的源代码。本节的其余部分将通过一些代码来演示使用流DSL创建topology的关键步骤，但我们建议开发者阅读完整的示例源代码的细节。</p>
<p>KStream and KTable</p>
<p>The DSL uses two main abstractions. A KStream is an abstraction of a record stream, where each data record represents a self-contained datum in the unbounded data set. A KTable is an abstraction of a changelog stream, where each data record represents an update. More precisely, the value in a data record is considered to be an update of the last value for the same record key, if any (if a corresponding key doesn’t exist yet, the update will be considered a create). To illustrate the difference between KStreams and KTables, let’s imagine the following two data records are being sent to the stream: (“alice”, 1) –&gt; (“alice”, 3). If these records a KStream and the stream processing application were to sum the values it would return 4. If these records were a KTable, the return would be 3, since the last record would be considered as an update.</p>
<p>DSL使用的两种主要的抽象。一个KStream是记录流的一个抽象的概念，其中每个数据记录代表一个独立的数据的数据集。一个KTable是一个变更的流的一个抽象的概念，其中每个数据记录的更新。更精确地说，数据记录中的值被认为是同一个记录键的最后一个值的更新，如果有（如果一个相应的key不存在，则该更新将被视为一个创建）。说明kstreams和KTables之间的差异，让我们想象一下以下两个数据记录被发送到流：(“alice”, 1)——&gt;(“alice”, 3)。如果这些记录KStream和流处理应用进行总结的值将返回4。如果这些记录是一个KTable，返回的返回的将是3，因为过去的记录将被视为一种更新。</p>
<p>Create Source Streams from Kafka<br>创建Kafka Streams</p>
<p>Either a record stream (defined as KStream) or a changelog stream (defined as KTable) can be created as a source stream from one or more Kafka topics (for KTable you can only create the source stream from a single topic).<br>一个记录流（定义为KStream）或更新流（定义为KTable）可以创建从一个或多个Kafka主题的源流（为KTable你只能从一个单一的主题创建源流）。 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">KStreamBuilder builder = <span class="keyword">new</span> KStreamBuilder();</div><div class="line">KStream source1 = builder.stream(<span class="string">"topic1"</span>, <span class="string">"topic2"</span>);</div><div class="line">KTable source2 = builder.table(<span class="string">"topic3"</span>, <span class="string">"stateStoreName"</span>);</div></pre></td></tr></table></figure>
<p>Windowing a stream 窗口流<br>A stream processor may need to divide data records into time buckets, i.e. to window the stream by time. This is usually needed for join and aggregation operations, etc. Kafka Streams currently defines the following types of windows:</p>
<p>流处理器可能需要将数据记录划分成时间桶，即通过时间窗口的流。这通常是需要的连接和聚合操作等。Kafka流目前定义了以下类型的窗口： </p>
<ul>
<li><p>Hopping time windows are windows based on time intervals. They model<br>fixed-sized, (possibly) overlapping windows. A hopping window is<br>defined by two properties: the window’s size and its advance interval<br>(aka “hop”). The advance interval specifies by how much a window<br>moves forward relative to the previous one. For example, you can<br>configure a hopping window with a size 5 minutes and an advance<br>interval of 1 minute. Since hopping windows can overlap a data record<br>may belong to more than one such windows.<br>跳跃的时间（跳时?）窗口是基于时间间隔的窗口。他们模型固定大小的，（可能）重叠的窗口。跳跃窗口是由两个属性定义的：窗口的大小和它的提前间隔（又名”hop”）。提前间隔由一个窗口相对于前一个窗口移动的多少来指定。例如，您可以配置一个具有大小5分钟和一个提前间隔1分钟的跳跃窗口。由于跳跃窗口可以重叠数据记录，可能属于多个这样的窗口。</p>
</li>
<li><p>Tumbling time windows are a special case of hopping time windows and,<br>like the latter, are windows based on time intervals. They model<br>fixed-size, non-overlapping, gap-less windows. A tumbling window is<br>defined by a single property: the window’s size. A tumbling window is<br>a hopping window whose window size is equal to its advance interval.<br>Since tumbling windows never overlap, a data record will belong to<br>one and only one window.<br>翻滚时间窗口是一个特殊的情况下的跳跃时间窗口，和后者一样，是基于时间间隔的窗口。他们模型固定的大小，不重叠，无缝隙的窗口。一个翻滚窗口是由一个单一属性定义的：窗口的大小。一个翻滚窗口是一个跳跃的窗口，它的窗口大小等于它的预先间隔。由于翻滚的窗口永远不会重叠，数据记录将属于一个并且只有一个窗口。 </p>
</li>
<li><p>Sliding windows model a fixed-size window that slides continuously<br>over the time axis; here, two data records are said to be included in<br>the same window if the difference of their timestamps is within the<br>window size. Thus, sliding windows are not aligned to the epoch, but<br>on the data record timestamps. In Kafka Streams, sliding windows are<br>used only for join operations, and can be specified through the<br>JoinWindows class.<br>滑动窗口模型一个固定大小的窗口，幻灯片不断在时间轴上；在这里，两个数据记录，说是如果他们的时间差异是在窗口的大小，包括在同一个窗口。因此，滑动窗口不一致的时代，但在数据记录的时间戳。Kafka流，滑动窗口只用于连接操作，并可以通过JoinWindows类指定。</p>
</li>
</ul>
<h3 id="Joins"><a href="#Joins" class="headerlink" title="Joins"></a>Joins</h3><p>A join operation merges two streams based on the keys of their data records, and yields a new stream. A join over record streams usually needs to be performed on a windowing basis because otherwise the number of records that must be maintained for performing the join may grow indefinitely. In Kafka Streams, you may perform the following join operations:<br>一个连接操作基于它们的数据记录的键合并两个流，并产生一个新的流。在记录流的加入通常需要执行在视窗基础否则记录必须保持履行加入的数量可以无限增长。在Kafka Streams中，您可以执行以下连接操作：</p>
<ul>
<li>KStream-to-KStream Joins are always windowed joins, since otherwise<br>the memory and state required to compute the join would grow<br>infinitely in size. Here, a newly received record from one of the<br>streams is joined with the other stream’s records within the<br>specified window interval to produce one result for each matching<br>pair based on user-provided ValueJoiner. A new KStream instance<br>representing the result stream of the join is returned from this<br>operator.<br>KStream-to-KStream Joins总是窗口连接，否则内存和计算所需的join会无限增长的大小。在这里，新接收的记录从一条数据流与其他流的记录在指定的窗口间隔为对每一个匹配的基于用户提供的ValueJoiner产生的一个结果。一个新的KStream实例表示的加入导致流从这个操作符返回。</li>
<li>KTable-to-KTable Joins are join operations designed to be consistent<br>with the ones in relational databases. Here, both changelog streams<br>are materialized into local state stores first. When a new record is<br>received from one of the streams, it is joined with the other<br>stream’s materialized state stores to produce one result for each<br>matching pair based on user-provided ValueJoiner. A new KTable<br>instance representing the result stream of the join, which is also a<br>changelog stream of the represented table, is returned from this<br>operator.<br>KTable-to-KTable Joins 操作设计与关系数据库中的一致行动。在这里，无论是修改流物化在当地商店。当一个新的记录从一个流的接收，它与其他流的物化状态存储为对每一个匹配的基于用户提供的ValueJoiner产生的一个结果。一个新的KTable实例代表了连接流，这也是一个代表表更新流，是从这个操作符返回。 </li>
<li>KStream-to-KTable Joins allow you to perform table lookups against a<br>changelog stream (KTable) upon receiving a new record from another<br>record stream (KStream). An example use case would be to enrich a<br>stream of user activities (KStream) with the latest user profile<br>information (KTable). Only records received from the record stream<br>will trigger the join and produce results via ValueJoiner, not vice<br>versa (i.e., records received from the changelog stream will be used<br>only to update the materialized state store). A new KStream instance<br>representing the result stream of the join is returned from this<br>operator.<br>KStream-to-KTable Joins允许你执行表查找和修改流（ktable）在从另一个记录流接收一个新的记录（KStream）。一个例子使用案例将丰富用户活动流（KStream）最新的用户配置文件信息（KTable）。只记录收到的记录流会触发连接并通过ValueJoiner产生结果，反之亦然（即记录收到更新流只会被用来更新物化状态存储）。一个新的KStream实例表示的加入导致流从这个操作符返回。</li>
</ul>
<p>Depending on the operands the following join operations are supported: inner joins, outer joins and left joins. Their semantics are similar to the corresponding operators in relational databases. a<br>Transform a stream</p>
<p>There is a list of transformation operations provided for KStream and KTable respectively. Each of these operations may generate either one or more KStream and KTable objects and can be translated into one or more connected processors into the underlying processor topology. All these transformation methods can be chained together to compose a complex processor topology. Since KStream and KTable are strongly typed, all these transformation operations are defined as generics functions where users could specify the input and output data types.</p>
<p>Among these transformations, filter, map, mapValues, etc, are stateless transformation operations and can be applied to both KStream and KTable, where users can usually pass a customized function to these functions as a parameter, such as Predicate for filter, KeyValueMapper for map, etc:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// written in Java 8+, using lambda expressions</span></div><div class="line">KStream mapped = source1.mapValue(record -&gt; record.get(<span class="string">"category"</span>));</div></pre></td></tr></table></figure></p>
<p>Stateless transformations, by definition, do not depend on any state for processing, and hence implementation-wise they do not require a state store associated with the stream processor; Stateful transformations, on the other hand, require accessing an associated state for processing and producing outputs. For example, in join and aggregate operations, a windowing state is usually used to store all the received records within the defined window boundary so far. The operators can then access these accumulated records in the store and compute based on them.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// written in Java 8+, using lambda expressions</span></div><div class="line">KTable, Long&gt; counts = source1.groupByKey().aggregate(</div><div class="line">    () -&gt; <span class="number">0</span>L,  <span class="comment">// initial value</span></div><div class="line">    (aggKey, value, aggregate) -&gt; aggregate + <span class="number">1</span>L,   <span class="comment">// aggregating value</span></div><div class="line">    TimeWindows.of(<span class="string">"counts"</span>, <span class="number">5000</span>L).advanceBy(<span class="number">1000</span>L), <span class="comment">// intervals in milliseconds</span></div><div class="line">    Serdes.Long() <span class="comment">// serde for aggregated value</span></div><div class="line">);</div><div class="line"></div><div class="line">KStream joined = source1.leftJoin(source2,</div><div class="line">    (record1, record2) -&gt; record1.get(<span class="string">"user"</span>) + <span class="string">"-"</span> + record2.get(<span class="string">"region"</span>);</div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>Write streams back to Kafka</p>
<p>At the end of the processing, users can choose to (continuously) write the final resulted streams back to a Kafka topic through KStream.to and KTable.to.<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">joined.to(<span class="string">"topic4"</span>);</div></pre></td></tr></table></figure></p>
<p>If your application needs to continue reading and processing the records after they have been materialized to a topic via to above, one option is to construct a new stream that reads from the output topic; Kafka Streams provides a convenience method called through:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// equivalent to</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// joined.to("topic4");</span></div><div class="line"><span class="comment">// materialized = builder.stream("topic4");</span></div><div class="line">KStream materialized = joined.through(<span class="string">"topic4"</span>);</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="张洪铭" />
          <p class="site-author-name" itemprop="name">张洪铭</p>
          <p class="site-description motion-element" itemprop="description">人生在勤 勤则不匮</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">张洪铭</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhm8"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  

  


</body>
</html>
